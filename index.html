<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Supabase client (global) -->
<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const SUPABASE_URL = "https://pgohlxaeakbxiqekkwrl.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBnb2hseGFlYWtieGlxZWtrd3JsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5NzU3MjEsImV4cCI6MjA3MDU1MTcyMX0.5RF__rQEwwSVFSNfbOce5YyKwc1gzH6FG8OpXbNugxI";

  window.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  window.SUPABASE_URL = SUPABASE_URL;
  window.SUPABASE_ANON_KEY = SUPABASE_ANON_KEY;
  console.log("[BUILD] supabase init injected");
</script>
<!-- Hydrate localStorage from Supabase (one-time, guarded) -->
<script type="module">
  const sb = window.supabase;
  if (!sb) {
    console.error("Supabase not initialized");
  } else {
    (async () => {
      // Prevent infinite loop: only run once per browser
      if (localStorage.getItem('mm_hydrated_once') === 'true') {
        console.log('[Hydrate] already done; skipping');
        return;
      }

      const toDate = d => d ? String(d).slice(0,10) : null;

      // Fetch data from Supabase. Request additional columns needed by the UI such as
      // onboardDate for clients, start_date/end_date/time/estimate_hours/status for tasks,
      // and time/phase/assignee/all_day/status for events. Some columns may be null if
      // they are absent in your database schema. The mapping below will normalise them
      // into the structure expected by the dashboard UI.
      const [{ data: clients }, { data: tasks }, { data: events }] = await Promise.all([
        sb.from("clients").select("id,name,color,status,onboardDate"),
        sb.from("tasks").select("id,title,client_id,due_date,start_date,end_date,time,phase,assignee,estimate_hours,status,created_at"),
        sb.from("events").select("id,title,client_id,start_date,end_date,time,phase,assignee,all_day,status,created_at")
      ]);

      // Map Supabase client rows to the shape expected by the UI. Ensure default
      // values for missing fields such as colour, status and onboardDate.
      const lsClients = (clients || []).map(c => ({
        id: c.id,
        name: c.name || "",
        color: c.color || "#888888",
        status: c.status || "none",
        onboardDate: c.onboardDate || null
      }));

      // Map Supabase task rows to UI structure. Convert date/time fields to ISO date
      // strings (YYYY‑MM‑DD) and rename snake_case keys to camelCase. Provide
      // sensible defaults for missing fields.
      const lsTasks = (tasks || []).map(t => {
        const startDate = t.start_date ? String(t.start_date).split('T')[0] : null;
        const dueDate = t.due_date ? String(t.due_date).split('T')[0] : (startDate || null);
        return {
          id: t.id,
          clientId: t.client_id || null,
          title: t.title || "",
          startDate: startDate,
          dueDate: dueDate,
          time: t.time || null,
          phase: t.phase || "None",
          assignee: t.assignee || null,
          estimateHours: (typeof t.estimate_hours === 'number' ? t.estimate_hours : 1),
          status: t.status || 'todo'
        };
      });

      // Map Supabase event rows to UI structure. Convert start/end dates to ISO
      // strings (YYYY‑MM‑DD) and normalise property names. Default allDay to
      // false if missing and supply a placeholder status.
      const lsEvents = (events || []).map(e => {
        const startDate = e.start_date ? String(e.start_date).split('T')[0] : null;
        const endDate   = e.end_date   ? String(e.end_date).split('T')[0]   : (startDate || null);
        return {
          id: e.id,
          clientId: e.client_id || null,
          title: e.title || "",
          date: startDate,
          endDate: endDate,
          time: e.time || null,
          phase: e.phase || "None",
          assignee: e.assignee || null,
          allDay: !!e.all_day,
          status: e.status || 'todo'
        };
      });

      localStorage.setItem("mm_clients", JSON.stringify(lsClients));
      localStorage.setItem("mm_tasks",   JSON.stringify(lsTasks));
      localStorage.setItem("mm_events",  JSON.stringify(lsEvents));
      localStorage.setItem("mm_view_user", "Team (All)");
      localStorage.setItem("mm_assignee_filter", "all");

      // Mark done so we never loop
      localStorage.setItem('mm_hydrated_once', 'true');

      // Only reload if we actually wrote any data
      if (lsClients.length || lsTasks.length || lsEvents.length) {
        console.log("[Hydrate] wrote & reloading once…");
        setTimeout(() => location.reload(), 150);
      } else {
        console.log("[Hydrate] nothing to write; no reload");
      }
    })();
  }
</script>
<!-- ===== TEMP: force no-auth mode so UI renders immediately ===== -->
<script type="module">
  // Ensure the supabase client exists
  if (!window.supabase) {
    console.error("Supabase not initialized");
  }

  // Hard-set a current user object for your UI to pick up (bypass real auth)
  window.CURRENT_USER = {
    id: "treyven-dev",
    name: "Treyven Marlow",
    email: "treyven@example.com",
    role: "owner"
  };

  // Force all filters to Team(All) so nothing is hidden by assignee
  try {
    localStorage.setItem("mm_view_user", "Team (All)");
    localStorage.setItem("mm_assignee_filter", "all");
  } catch {}

  // Tiny sanity log
  console.log("[TEMP] No-auth mode enabled. Rendering Team (All).");
</script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Updated version tag appended to the title so users can verify they are using the latest build -->
<title>Marlow Media Dashboard – vAug15-J</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
/* Scrollbar styling */
::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(0, 0, 0, 0.3); border-radius: 4px; }
</style>
<!-- Override dark mode classes to always use light colors -->
<style>
/* Convert dark backgrounds to light backgrounds */
.dark\:bg-zinc-900,
.dark\:bg-zinc-800,
.dark\:bg-zinc-950 {
  background-color: #ffffff !important;
}
/* Convert dark hover backgrounds to light hover backgrounds */
.dark\:hover\:bg-zinc-800:hover,
.dark\:hover\:bg-zinc-900:hover {
  background-color: #f5f5f5 !important;
}
/* Convert dark text to dark (black) text */
.dark\:text-zinc-100 {
  color: #000000 !important;
}
/* Convert dark borders to light borders */
.dark\:border-zinc-800 {
  border-color: #e5e5e5 !important;
}

/* Shading classes for onboarding and halfway dates */
.shade-onboard { background: #fefcf8 !important; box-shadow: inset 0 0 0 1px #fde68a; }
.shade-halfway { background: #e0f7fa !important; box-shadow: inset 0 0 0 2px #0ea5e9; }
/* Late badge styling for overdue tasks */
.badge-late { background: #fee2e2; color: #b91c1c; }

  /* Highlighted range styling when clicking on a task */
.highlighted-range { background: #fff7ed !important; box-shadow: inset 0 0 0 1px #fde68a; }
</style>
</head>
<body class="bg-zinc-50 text-zinc-900">
  <div id="app"></div>
  <!-- Login overlay: displayed until user logs in -->
  <div id="login-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50" style="display:none">
    <div class="bg-white p-6 rounded-2xl shadow-lg max-w-md w-full">
      <h2 class="text-lg font-semibold mb-4">Sign In</h2>
      <form id="supabase-login-form" class="space-y-3">
        <input type="email" id="login-email" class="w-full px-3 py-2 rounded-xl border border-zinc-300" placeholder="Email" required />
        <input type="password" id="login-password" class="w-full px-3 py-2 rounded-xl border border-zinc-300" placeholder="Password" required />
        <button type="submit" class="w-full px-4 py-2 rounded-xl bg-black text-white">Sign In / Sign Up</button>
      </form>
      <p class="text-xs text-zinc-500 mt-2">Please login to continue.</p>
    </div>
  </div>
<script>

// ==== Utility helpers ====
const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
// Return the current date in ISO format (YYYY-MM-DD) based on the user's
// local timezone rather than UTC. Adjusting by the timezone offset avoids
// incorrectly shifting the date when using Date().toISOString().slice().
const todayISO = () => {
  const now = new Date();
  // Offset by timezone to get a local date string in ISO format
  const local = new Date(now.getTime() - now.getTimezoneOffset() * 60000);
  return local.toISOString().slice(0, 10);
};
const fmtDate = (iso) => new Date(iso + "T00:00:00").toLocaleDateString();

// Return a list of events occurring between today and today+rangeDays. If rangeDays is
// null, all upcoming events are returned. Events are sorted by date then time.
function getEventsInRange(rangeDays) {
  const now = new Date();
  // normalize start to midnight for comparison
  const start = new Date(now.toDateString());
  const end = rangeDays ? new Date(start.getTime() + rangeDays * 24 * 60 * 60 * 1000) : null;
  return state.events.filter(ev => {
    // Skip archived events
    if (ev.status === 'done') return false;
    const d = new Date(ev.date + 'T00:00:00');
    return (!rangeDays || (d >= start && d <= end));
  }).sort((a,b) => a.date.localeCompare(b.date) || (a.time || '').localeCompare(b.time || ''));
}

// Group consecutive events that share the same title, client, phase, allDay and time
// into a single range object with start and end dates. Returns an array of grouped
// objects: { id, clientId, title, phase, allDay, time, date, endDate }
function groupEvents(events) {
  const grouped = [];
  events.forEach(ev => {
    const last = grouped[grouped.length - 1];
    if (last && last.title === ev.title && last.clientId === ev.clientId && last.phase === ev.phase && last.allDay === ev.allDay && (!last.time || last.time === ev.time) && (new Date(ev.date) - new Date(last.endDate)) === 24 * 60 * 60 * 1000) {
      // extend the previous range
      last.endDate = ev.date;
    } else {
      // clone event and initialise endDate equal to start date
      grouped.push(Object.assign({}, ev, { endDate: ev.date }));
    }
  });
  return grouped;
}

// Collapse events across the entire list that share the same title, client, phase,
// allDay and time into a single object with the earliest start date and latest
// end date. This ignores whether the days are consecutive and treats all
// occurrences of the same task as one entry. Returns a sorted array.
function collapseEvents(events) {
  const groups = {};
  events.forEach(ev => {
    const key = ev.clientId + '|' + ev.title + '|' + ev.phase + '|' + ev.allDay + '|' + (ev.time || '');
    if (!groups[key]) {
      // start a new aggregated group
      groups[key] = Object.assign({}, ev, { endDate: ev.date });
    } else {
      const g = groups[key];
      // update start and end dates
      if (ev.date < g.date) g.date = ev.date;
      if (ev.date > g.endDate) g.endDate = ev.date;
    }
  });
  // convert map to array and sort by start date
  return Object.values(groups).sort((a,b) => a.date.localeCompare(b.date) || (a.time||'').localeCompare(b.time||''));
}

// ====== Highlight Helpers ======
// Remove existing highlighted cells across all rendered calendars
function clearHighlights() {
  document.querySelectorAll('.highlighted-range').forEach(el => el.classList.remove('highlighted-range'));
}

// Highlight a range of dates across all calendars. StartISO and endISO are inclusive strings in YYYY-MM-DD format.
function highlightCalendarRange(startISO, endISO) {
  clearHighlights();
  const start = new Date(startISO + 'T00:00:00');
  const end = new Date((endISO || startISO) + 'T00:00:00');
  document.querySelectorAll('[data-date]').forEach(cell => {
    const cellIso = cell.getAttribute('data-date');
    if (!cellIso) return;
    const cd = new Date(cellIso + 'T00:00:00');
    if (cd >= start && cd <= end) {
      cell.classList.add('highlighted-range');
    }
  });
}

// === Task helpers ===
// Convert a date (YYYY-MM-DD) and optional time (HH:mm) into a Date object.
// If no time is provided, treat the due time as the end of the day to avoid
// negative day counts when computing days-left for tasks.
function toDateTime(yyyyMmDd, hhmm) {
  if (!yyyyMmDd) return null;
  const [y, m, d] = yyyyMmDd.split('-').map(Number);
  if (hhmm && /^\d{2}:\d{2}$/.test(hhmm)) {
    const [H, Mi] = hhmm.split(':').map(Number);
    return new Date(y, m - 1, d, H, Mi);
  }
  // Default to end of day
  return new Date(y, m - 1, d, 23, 59);
}

// Return the number of days from today until the given due date/time. Negative
// values indicate the task is overdue. null is returned if due date is missing.
function daysUntil(dueDate, time) {
  if (!dueDate) return null;
  const due = toDateTime(dueDate, time);
  const now = new Date();
  // Reset both to start-of-day to avoid partial day differences
  const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const startOfDue = new Date(due.getFullYear(), due.getMonth(), due.getDate());
  return Math.floor((startOfDue - startOfToday) / (24 * 60 * 60 * 1000));
}

// Compute an urgency score for a task. Higher scores mean the task should be
// prioritised sooner. Overdue tasks get a large boost. Shorter estimates are
// preferred. Completed tasks get a large negative penalty so they sort to the
// end. This function is used by sortTasksByUrgency().
function taskUrgencyScore(t) {
  const dLeft = daysUntil(t.dueDate, t.time);
  const est = Number(t.estimateHours || 1);
  const isDone = t.status === 'done';
  const isOverdue = dLeft !== null && dLeft < 0 && !isDone;
  const overdueBoost = isOverdue ? 1000 : 0;
  // Deadline score: tasks due sooner get higher values. Bound between ±60 days.
  const deadlineScore = dLeft === null ? 0 : (50 - Math.max(-30, Math.min(30, dLeft)) * 2);
  const estimateScore = 10 / Math.max(0.5, est);
  const donePenalty = isDone ? -2000 : 0;
  return overdueBoost + deadlineScore + estimateScore + donePenalty;
}

// Sort tasks by urgency: overdue first, then tasks due soon, then shorter tasks.
function sortTasksByUrgency(list) {
  return [...list].sort((a, b) => taskUrgencyScore(b) - taskUrgencyScore(a));
}

// ===== Employee filtering helpers =====
// Return tasks visible to the current user. The manager (Treyven Marlow)
// sees all tasks, while employees see only those assigned to them.
function getVisibleTasks() {
  const cur = state.currentEmployeeId;
  const mode = state.viewMode || 'team';
  // If no user (shouldn't happen) treat as manager
  if (!cur) {
    return state.tasks || [];
  }
  // Manager (Treyven) has two modes: team vs self. Team shows all tasks. Self shows only
  // manager's tasks and unassigned tasks.
  if (cur === 'Treyven Marlow') {
    if (mode === 'team') {
      return state.tasks || [];
    } else if (mode === 'self') {
      return (state.tasks || []).filter(t => !t.assignee || t.assignee === cur);
    }
  }
  // Non-manager employees always see only their assigned tasks
  return (state.tasks || []).filter(t => t.assignee === cur);
}
// Return events visible to the current user. The manager sees all events,
// employees see only those where assignee matches them.
function getVisibleEvents() {
  const cur = state.currentEmployeeId;
  const mode = state.viewMode || 'team';
  if (!cur) {
    return state.events || [];
  }
  // Manager view: show all events in team mode; show only manager/unassigned events in self mode
  if (cur === 'Treyven Marlow') {
    if (mode === 'team') {
      return state.events || [];
    } else if (mode === 'self') {
      return (state.events || []).filter(ev => !ev.assignee || ev.assignee === cur);
    }
  }
  // Regular employee: show only events assigned to them
  return (state.events || []).filter(ev => ev.assignee === cur);
}

// Move a task to a new date. Adjusts the start and due dates based on the
// original span. If the task has both startDate and dueDate, the difference
// in days is preserved. If only one date is defined, only that date is
// updated. After mutating the task, callers should saveState() and render().
function moveTask(taskId, newIsoDate) {
  const t = (state.tasks || []).find(x => x.id === taskId);
  if (!t) return;
  // Determine which dates exist and compute span
  const s = t.startDate || t.dueDate;
  const e = t.dueDate || t.startDate;
  if (t.startDate && t.dueDate) {
    const spanDays = Math.round((new Date(t.dueDate + 'T00:00:00') - new Date(t.startDate + 'T00:00:00')) / (24*60*60*1000));
    t.startDate = newIsoDate;
    const nd = new Date(newIsoDate + 'T00:00:00');
    nd.setDate(nd.getDate() + spanDays);
    t.dueDate = nd.toISOString().slice(0,10);
  } else if (t.startDate) {
    t.startDate = newIsoDate;
  } else if (t.dueDate) {
    t.dueDate = newIsoDate;
  }
}

// Move an event to a new date. Preserves multi‑day span by shifting the
// endDate relative to the start date if present. If the event has an
// endDate, the difference in days is applied to the new date. Call
// saveState() and render() after using this helper.
function moveEvent(eventId, newIsoDate) {
  const ev = state.events.find(e => e.id === eventId);
  if (!ev) return;
  const diffDays = ev.endDate ? Math.round((new Date(ev.endDate + 'T00:00:00') - new Date(ev.date + 'T00:00:00')) / (24*60*60*1000)) : 0;
  ev.date = newIsoDate;
  if (ev.endDate) {
    const nd = new Date(newIsoDate + 'T00:00:00');
    nd.setDate(nd.getDate() + diffDays);
    ev.endDate = nd.toISOString().slice(0,10);
  }
}
// Change the active employee (fake login). Passing an empty string reverts to manager.
function setCurrentEmployee(empId) {
  // When selecting an employee from the dropdown, update both the current employee and the view mode.
  // The special value 'team' indicates the manager wants to view the entire team's assignments.
  if (!empId || empId === 'team') {
    state.viewMode = 'team';
    // In team mode, default the currentEmployeeId to the manager so names like (You) resolve properly
    state.currentEmployeeId = 'Treyven Marlow';
  } else if (empId === 'Treyven Marlow') {
    // Manager viewing their own assignments only
    state.viewMode = 'self';
    state.currentEmployeeId = empId;
  } else {
    // Viewing an individual employee's assignments
    state.viewMode = 'employee';
    state.currentEmployeeId = empId;
  }
  saveState();
  render();
}
// Compute a suffix for displaying an assignee on a task or event title.
// Shows "(You)" for tasks assigned to the current user, or the employee name for others.
function assigneeSuffix(assignee) {
  if (!assignee) return '';
  if (assignee === state.currentEmployeeId) {
    return ' (You)';
  }
  // If this is a manager's own task and the viewer is the manager, omit the suffix.
  if (assignee === 'Treyven Marlow' && state.currentEmployeeId === 'Treyven Marlow') {
    return '';
  }
  const emp = (state.employees || []).find(e => e.id === assignee);
  const name = (emp && emp.name) || assignee;
  return ' (' + name + ')';
}

// Compute days until the next due item (task or event) for a specific client.
// Returns a negative number if the nearest due task is overdue. Returns null
// if there are no tasks or events for the client.
// Compute days until the next actionable date for a client. The logic prioritizes
// upcoming tasks and events (status !== 'done') that are scheduled on or
// after today. If there are overdue items (dueDate in the past), the
// function returns a negative number reflecting the number of days late for
// the most recently missed item. When there are no tasks or events for the
// client, it falls back to calculating the days until the start of the next
// content cycle based on the client's onboarding date. A bi‑weekly cycle
// (14 days) is assumed. If onboarding date is missing, null is returned.
function nextDaysLeftForClient(clientId) {
  // Determine the days remaining until the next content cycle for this client.
  // A fixed 28‑day cycle is used (four weeks). Each cycle begins at the
  // client's onboarding date, and repeats every 28 days thereafter. The
  // calculation ignores individual tasks and events and focuses solely on
  // the cycle.
  const client = state.clients.find(c => c.id === clientId);
  if (!client || !client.onboardDate) return null;
  const onboard = new Date(client.onboardDate + 'T00:00:00');
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const cycleLength = 28; // length of one content cycle in days
  // Compute the number of days elapsed since the onboarding date
  const diffDays = Math.floor((today - onboard) / (24 * 60 * 60 * 1000));
  // If the onboarding date is in the future (diffDays < 0), return days until onboarding
  if (diffDays < 0) {
    return Math.abs(diffDays);
  }
  // If today is exactly on a cycle boundary
  if (diffDays % cycleLength === 0) return 0;
  // Otherwise calculate days until next cycle
  const remainder = diffDays % cycleLength;
  return cycleLength - remainder;
}

// Render a ribbon at the top of the page if there are overdue tasks across all clients.
// The ribbon informs the user how many tasks are late. It appears above the
// main content container when there are overdue tasks and disappears when
// there are none. Clicking the ribbon could navigate to a tasks view or
// simply draws attention to the pending items.
function renderOverdueRibbon(container) {
  // Remove any existing ribbon
  const existing = container.querySelector('#overdueRibbon');
  if (existing) existing.remove();
  // Only include tasks visible to the current user when computing the overdue ribbon
  const overdue = getVisibleTasks().filter(t => {
    const d = daysUntil(t.dueDate, t.time);
    return d !== null && d < 0 && t.status !== 'done';
  });
  if (!overdue || overdue.length === 0) return;
  const ribbon = document.createElement('div');
  ribbon.id = 'overdueRibbon';
  ribbon.className = 'mb-4 p-3 rounded-xl bg-rose-50 border border-rose-200 text-rose-800 flex items-center justify-between';
  ribbon.innerHTML = '<span>⚠️ ' + overdue.length + ' task' + (overdue.length>1?'s':'') + ' overdue.</span>' +
    '<button class="text-sm underline" onclick="setTab(\'Clients\')">View</button>';
  container.insertBefore(ribbon, container.firstChild);
}

// ---- Calendar Navigation Helpers ----
// Compute month name and year for a given Date object
function monthLabel(d) {
  return d.toLocaleString(undefined, { month: 'long', year: 'numeric' });
}

// Render a month view calendar with navigation controls for the Overview tab.
// It uses state.monthOffset to shift the month forward/backwards relative to
// the current month. Clicking the arrows adjusts the offset and re-renders.
function renderOverviewMonthWithNav() {
  const wrapper = document.createElement('div');
  const nav = document.createElement('div');
  nav.className = 'flex items-center justify-between mb-2';
  // Determine the month to display based on offset
  const base = new Date();
  base.setDate(1);
  const displayMonth = new Date(base.getFullYear(), base.getMonth() + state.monthOffset, 1);
  // Build navigation buttons
  const prev = document.createElement('button');
  prev.className = 'px-3 py-1 rounded-xl bg-zinc-100 hover:bg-zinc-200';
  prev.textContent = '←';
  prev.onclick = () => { state.monthOffset--; render(); };
  const next = document.createElement('button');
  next.className = 'px-3 py-1 rounded-xl bg-zinc-100 hover:bg-zinc-200';
  next.textContent = '→';
  next.onclick = () => { state.monthOffset++; render(); };
  const label = document.createElement('div');
  label.className = 'font-medium';
  label.textContent = monthLabel(displayMonth);
  nav.appendChild(prev);
  nav.appendChild(label);
  nav.appendChild(next);
  wrapper.appendChild(nav);
  wrapper.appendChild(renderOverviewMonth(displayMonth));
  return wrapper;
}

// Render a client calendar with navigation controls. Uses
// state.clientMonthOffsets to track the month shift for each client separately.
function renderClientCalendarWithNav(client, monthDate) {
  const wrapper = document.createElement('div');
  const nav = document.createElement('div');
  nav.className = 'flex items-center justify-between mb-2';
  // Determine display month based on offset stored for this client
  const offset = state.clientMonthOffsets[client.id] || 0;
  const base = new Date();
  base.setDate(1);
  const displayMonth = new Date(base.getFullYear(), base.getMonth() + offset, 1);
  // Navigation buttons
  const prev = document.createElement('button');
  prev.className = 'px-3 py-1 rounded-xl bg-zinc-100 hover:bg-zinc-200';
  prev.textContent = '←';
  prev.onclick = () => {
    state.clientMonthOffsets[client.id] = (state.clientMonthOffsets[client.id] || 0) - 1;
    saveState();
    render();
  };
  const next = document.createElement('button');
  next.className = 'px-3 py-1 rounded-xl bg-zinc-100 hover:bg-zinc-200';
  next.textContent = '→';
  next.onclick = () => {
    state.clientMonthOffsets[client.id] = (state.clientMonthOffsets[client.id] || 0) + 1;
    saveState();
    render();
  };
  const label = document.createElement('div');
  label.className = 'font-medium';
  label.textContent = monthLabel(displayMonth);
  nav.appendChild(prev);
  nav.appendChild(label);
  nav.appendChild(next);
  wrapper.appendChild(nav);
  wrapper.appendChild(renderClientCalendar(client, displayMonth));
  return wrapper;
}

// Show a confirmation modal before deleting an event. Avoids accidental deletion.
function openDeleteEventConfirm(eventId) {
  const ev = state.events.find(e => e.id === eventId);
  if (!ev) return;
  openModal('Delete Event', () => {
    const div = document.createElement('div');
    div.className = 'space-y-4';
    const client = state.clients.find(c => c.id === ev.clientId) || { name:'Unknown' };
    div.innerHTML = `<p>Are you sure you want to delete the event <strong>${ev.title}</strong> for client <strong>${client.name}</strong>?</p>
      <div class="flex justify-end gap-2 flex-wrap">
        <button onclick="closeModal()" class="px-3 py-2 rounded-xl bg-zinc-100">Cancel</button>
        <button onclick="confirmDeleteEvent('${eventId}')" class="px-3 py-2 rounded-xl bg-red-600 hover:bg-red-700 text-white">Delete</button>
        <button onclick="confirmDeleteEventAll('${eventId}')" class="px-3 py-2 rounded-xl bg-red-600 hover:bg-red-700 text-white">Delete All Future</button>
      </div>`;
    return div;
  });
}

function confirmDeleteEvent(id) {
  deleteEvent(id);
  closeModal();
}

// Delete all events with the same title for the same client on or after the selected event date.
function confirmDeleteEventAll(id) {
  const ev = state.events.find(e => e.id === id);
  if (!ev) return;
  const targetDate = new Date(ev.date + 'T00:00:00');
  state.events = state.events.filter(e => {
    if (e.clientId === ev.clientId && e.title === ev.title) {
      const d = new Date(e.date + 'T00:00:00');
      // Remove events that occur on or after the target event's date
      if (d >= targetDate) return false;
    }
    return true;
  });
  saveState();
  closeModal();
  render();
}

// LocalStorage hooks
function useLocalStorage(key, initial) {
  const value = localStorage.getItem(key);
  return value ? JSON.parse(value) : initial;
}
function saveLocalStorage(key, value) {
  localStorage.setItem(key, JSON.stringify(value));
}

// ==== Initial Data Structures ====
const DEFAULT_COLORS = ["#22c55e","#3b82f6","#eab308","#ef4444","#a855f7","#14b8a6","#f97316","#8b5cf6"];
const PACKAGES = {
  // Each package defines counts for various deliverable types. Emails and phone
  // campaigns mirror the number of videos for simplicity, while directMail has a fixed count.
  mini:   { videos: 4, carousels: 4, photos: 4, emails: 4, phones: 4, directMail: 2 },
  medium: { videos: 8, carousels: 4, photos: 5, emails: 8, phones: 8, directMail: 2 },
  large:  { videos:12, carousels: 5, photos: 6, emails:12, phones:12, directMail: 2 },
  mega:   { videos:16, carousels: 6, photos: 7, emails:16, phones:16, directMail: 2 }
};

// Title text shown in the header instead of the logo. Adjust as desired.
// Customize the header text shown in the navigation bar. Feel free to adjust this to suit your branding.
const COMPANY_TITLE = 'Marlow Media Team Hub';

// ==== App State ====
let state = {
  tab: 'Overview',
  clients: useLocalStorage('mm_clients', []),
  events: useLocalStorage('mm_events', []),
  activeClientId: localStorage.getItem('mm_active_client') || null,
  logo: localStorage.getItem('mm_logo') || null,
  contentData: useLocalStorage('mm_contentData', {}), // map clientId -> content object
  contentArchive: useLocalStorage('mm_contentArchive', {}), // map clientId -> list of archives
  contentClientId: null, // currently open client in content tab
  // rangeDays determines how far forward the schedule and overview pages look when computing
  // weekly tasks and client summaries. The buttons on the Schedule page update this value.
  rangeDays: 30,
  // analytics view state: selected client and saved handles
  analyticsClientId: null,
  analyticsHandles: useLocalStorage('mm_analyticsHandles', {}),

  // --- Task tracking ---
  // Persist an array of tasks. Each task has: id, clientId, title, dueDate (YYYY-MM-DD),
  // time (HH:mm or empty for all-day), estimateHours (number), and status
  // ('todo','doing','blocked','done'). Tasks allow you to track deliverables
  // independently from calendar events. They can be used to compute
  // upcoming deadlines and overdue items. See helpers below for
  // urgency scoring and days-left calculations.
  tasks: useLocalStorage('mm_tasks', []),

  // --- Employees ---
  // Persist a list of employees. Each employee has: id (unique string), name.
  // This list is used when assigning tasks to teammates. It defaults to two
  // entries for Treyven Marlow and Ryan Hatfield when first loaded.
  employees: useLocalStorage('mm_employees', []),

  // --- Current user ---
  // Track the currently logged in employee's id. In a real supabase-enabled
  // environment, this would come from the auth session. For this local
  // offline mode, we default to Treyven Marlow. Use this value when
  // determining which tasks to show and when creating new tasks.
  currentEmployeeId: 'Treyven Marlow',

  // View mode indicates how tasks/events should be filtered on overview-type pages.
  // 'team' (default) shows all tasks/events across the company.
  // 'self' shows only tasks/events assigned to the current employee, plus any unassigned tasks (manager-only).
  // 'employee' shows only tasks/events assigned exactly to the current employee (for non-managers).
  viewMode: useLocalStorage('mm_viewMode', 'team'),

  // Track month navigation offset for the Overview calendar. Persist to localStorage
  // so returning to the app retains the same month view. Defaults to 0 (current month).
  monthOffset: useLocalStorage('mm_monthOffset', 0),

  // Track per-client month offsets for their individual calendars. Persist to
  // localStorage so each client's calendar remembers its position across
  // sessions. Defaults to an empty object.
  clientMonthOffsets: useLocalStorage('mm_clientMonthOffsets', {}),
};

// Global set of currently selected tasks for bulk operations. This is not persisted.
let selectedTaskIds = new Set();

// Save watchers
function saveState() {
  saveLocalStorage('mm_clients', state.clients);
  saveLocalStorage('mm_events', state.events);
  saveLocalStorage('mm_contentData', state.contentData);
  saveLocalStorage('mm_contentArchive', state.contentArchive);
  // Persist tasks so they remain across sessions
  saveLocalStorage('mm_tasks', state.tasks);
  // Persist employees so new employees remain across sessions
  saveLocalStorage('mm_employees', state.employees);
  // Persist analytics handles so per-client handles persist across sessions
  saveLocalStorage('mm_analyticsHandles', state.analyticsHandles);
  // Persist month offsets so the current calendar view is retained across sessions
  saveLocalStorage('mm_monthOffset', state.monthOffset);
  saveLocalStorage('mm_clientMonthOffsets', state.clientMonthOffsets);
  if (state.activeClientId) localStorage.setItem('mm_active_client', state.activeClientId);
  if (state.logo) localStorage.setItem('mm_logo', state.logo);

  // Persist viewMode so page preferences remain across sessions
  saveLocalStorage('mm_viewMode', state.viewMode);
}

// Initialize employees if none exist. This runs on first load to ensure
// the default employees (Treyven Marlow and Ryan Hatfield) are present.
if (!state.employees || state.employees.length === 0) {
  state.employees = [
    { id: 'Treyven Marlow', name: 'Treyven Marlow' },
    { id: 'Ryan Hatfield', name: 'Ryan Hatfield' }
  ];
  saveState();
}

// ================================================================
// Migration helper to copy tasks from localStorage into Supabase.
//
// This utility reads any tasks that are currently stored in the
// localStorage-based mm_tasks array and writes them into the
// `employee_tasks` table in Supabase. It preserves the task id and
// title and due date, and assigns the current logged-in user as
// the assignee for all tasks. Additional fields such as startDate,
// status or phase are not persisted here because the minimal
// employee_tasks schema only supports id/title/due_date/assignee.
//
// After running this migration, your tasks remain in localStorage
// (so the app continues to function in offline mode) but are
// duplicated in your Supabase project. You should run this once
// after you have logged in via Supabase to ensure your existing
// tasks are preserved before switching the app to load tasks from
// the database.
async function migrateLocalTasks() {
  try {
    // Ensure Supabase is available and the user is logged in
    if (!window.supabase || !window.supabase.auth) {
      alert('Supabase is not available in this environment. Please ensure your environment variables are set and reload the page.');
      return;
    }
    const { data: userData, error: userError } = await window.supabase.auth.getUser();
    if (userError || !userData || !userData.user) {
      alert('You must be logged in to migrate tasks. Please sign in first.');
      return;
    }
    const userId = userData.user.id;
    // Load existing tasks from localStorage. We bypass state.tasks here
    // so that any unsaved changes are also captured.
    const localTasks = useLocalStorage('mm_tasks', []);
    if (!Array.isArray(localTasks) || localTasks.length === 0) {
      alert('No local tasks found to migrate.');
      return;
    }
    // Prepare the payload for insertion. Only include columns that exist
    // in the employee_tasks table: title, due_date and assignee. We deliberately
    // omit the id here – the database will generate a new UUID for each row.
    // Normalise the dueDate to a YYYY-MM-DD string if provided, otherwise set null.
    const payload = localTasks.map(t => {
      let due = null;
      // Prefer t.dueDate; if missing, fall back to t.startDate for backwards compatibility
      if (t.dueDate) {
        // If dueDate contains a time component, strip it off
        due = String(t.dueDate).split('T')[0];
      } else if (t.startDate) {
        due = String(t.startDate).split('T')[0];
      }
      return {
        title: t.title || '',
        due_date: due || null,
        assignee: userId
      };
    });
    // Insert the tasks. Supabase expects an array of objects. If a row
    // already exists with the same id it will fail; however, repeated
    // migrations should not be necessary. You can safely ignore
    // individual errors if duplicates exist.
    const { error } = await window.supabase.from('employee_tasks').insert(payload, { upsert: false });
    if (error) {
      console.error('Task migration error:', error);
      alert('Migration failed: ' + (error.message || 'Unknown error'));
      return;
    }
    alert('Successfully migrated ' + payload.length + ' tasks to Supabase.');
  } catch (err) {
    console.error('Unexpected error during migration:', err);
    alert('An unexpected error occurred during migration. Check the console for details.');
  }
}

// ==== Rendering ====
const appEl = document.getElementById('app');

function render() {
  appEl.innerHTML = '';
  // Header
  const header = document.createElement('header');
  header.className = 'sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-zinc-200';
  // Build nav HTML
  let navHtml = '';
  // Define navigation items for main pages. Team/Treyven/Ryan pages are now selected via the employee dropdown instead of separate tabs.
  ['Overview','Clients','Employees','Schedule','Content','Analytics','Archive'].forEach(t => {
    const active = state.tab === t;
    navHtml += '<button onclick="setTab(\'' + t + '\')" class="px-3 py-2 rounded-xl text-sm font-medium hover:bg-zinc-100 dark:hover:bg-zinc-800 ' + (active?'bg-zinc-200 dark:bg-zinc-800':'') + '">' + t + '</button>';
  });
  // Build employee select options. Include a Team option for viewing all tasks/events across the company.
  let employeeOptions = '';
  // The first option allows managers to view the whole team. Selecting this sets viewMode to 'team'.
  employeeOptions += '<option value="team"' + (state.viewMode === 'team' ? ' selected' : '') + '>Team (All)</option>';
  // Generate an option for each employee. Selecting the manager shows only their own assignments (self mode),
  // while selecting another employee shows just that employee's assignments (employee mode).
  (state.employees || []).forEach(emp => {
    // Determine if this employee should be selected. In self mode or employee mode, match the currentEmployeeId.
    const selected = (state.viewMode !== 'team' && state.currentEmployeeId === emp.id) ? ' selected' : '';
    employeeOptions += '<option value="' + emp.id + '"' + selected + '>' + emp.name + '</option>';
  });
  // Use a full-width flex container for the header to eliminate large margins and center
  // the title and navigation nicely. The left section holds the company name and nav; the
  // right section holds the employee selector.
  // Tighten the side padding on the header so the content stretches closer to
  // the edges of the viewport. Previously we used px-4 which resulted in a
  // large gap on the left side. Using px-2 here brings the company title and
  // navigation closer to the edges while still preserving a little breathing
  // room.
  header.innerHTML = `<div class="w-full px-2 py-3 flex items-center justify-between">
    <div class="flex items-center flex-wrap gap-4">
      <span class="text-xl font-bold whitespace-nowrap">${COMPANY_TITLE}</span>
      <nav class="flex items-center flex-wrap gap-2">${navHtml}</nav>
    </div>
    <div class="flex items-center">
      <select id="employeeSelect" class="px-3 py-1.5 rounded-xl border border-zinc-300 text-sm">${employeeOptions}</select>
    </div>
  </div>`;
  appEl.appendChild(header);
  // Attach change handler to employee selector after the header is added
  setTimeout(() => {
    const sel = document.getElementById('employeeSelect');
    if (sel) {
      sel.onchange = (e) => {
        setCurrentEmployee(e.target.value);
      };
    }
  }, 0);

  // Main container (full width)
  const main = document.createElement('main');
  // Use full width and allow content to stretch across the page
  // Reduce horizontal padding so the content stretches closer to the edges. A small
  // padding is retained to prevent text from touching the browser edge.
  main.className = 'w-full px-2 py-4';
  appEl.appendChild(main);

  // Display overdue tasks ribbon at the top of the main container if there are any
  renderOverdueRibbon(main);
  if (state.tab === 'Team' || state.tab === 'Treyven' || state.tab === 'Ryan' || state.tab === 'Overview') {
    // For Team, Treyven, Ryan and Overview tabs, reuse the overview page component.
    main.appendChild(renderOverview());
  } else if (state.tab === 'Clients') {
    main.appendChild(renderClientsPage());
  } else if (state.tab === 'Employees') {
    main.appendChild(renderEmployeesPage());
  } else if (state.tab === 'Schedule') {
    main.appendChild(renderSchedulePage());
  } else if (state.tab === 'Content') {
    main.appendChild(renderContentPage());
  } else if (state.tab === 'Analytics') {
    main.appendChild(renderAnalyticsPage());
  } else if (state.tab === 'Archive') {
    main.appendChild(renderArchivePage());
  }

  if (modalState.open) {
    appEl.appendChild(renderModal());
  }
}

function setTab(tab) {
  // Update the current tab and reset page-specific state without altering the view mode.
  state.tab = tab;
  state.contentClientId = null;
  // Reset analytics selection when leaving the Analytics tab
  if (tab !== 'Analytics') {
    state.analyticsClientId = null;
  }
  render();
}

// ==== Modal State and Controls ====
const modalState = { open: false, title: '', content: null };
function openModal(title, content) {
  modalState.open = true;
  modalState.title = title;
  modalState.content = content;
  render();
}
function closeModal() {
  modalState.open = false;
  modalState.title = '';
  modalState.content = null;
  render();
}
function openLogoModal() {
  openModal('Upload Logo', () => {
    const div = document.createElement('div');
    div.className = 'space-y-3';
    div.innerHTML = `<input type="file" accept="image/*" id="logoInput" class="w-full" />
<div class="text-sm text-zinc-600">Logo is stored locally in your browser.</div>`;
    div.querySelector('#logoInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        state.logo = reader.result;
        saveState();
        closeModal();
      };
      reader.readAsDataURL(file);
    });
    return div;
  });
}
function renderModal() {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 z-50 grid place-items-center bg-black/50 p-4';
  modal.innerHTML = `<div class="w-full max-w-xl rounded-2xl shadow-xl bg-white">
    <div class="flex items-center justify-between p-4 border-b border-zinc-200 dark:border-zinc-800">
      <h3 class="text-lg font-semibold">${modalState.title}</h3>
      <button onclick="closeModal()" class="p-2 rounded-xl hover:bg-zinc-100 dark:hover:bg-zinc-800" aria-label="Close">✕</button>
    </div>
    <div class="p-4" id="modalBody"></div>
  </div>`;
  setTimeout(() => {
    const body = modal.querySelector('#modalBody');
    body.innerHTML = '';
    const contentEl = modalState.content();
    body.appendChild(contentEl);
  }, 0);
  return modal;
}

// ==== Overview Page ====
function renderOverview() {
  const container = document.createElement('div');
  container.className = 'space-y-6';
  // Compute events in the current range and group them by consecutive days
  // Always compute the summary for the current calendar week (Sunday to Saturday). This avoids showing
  // tasks from the following week when the range is larger than a week.
  const now = new Date();
  // Determine the start of the week (Sunday) and end (Saturday)
  const weekStart = new Date(now);
  weekStart.setDate(now.getDate() - weekStart.getDay());
  weekStart.setHours(0, 0, 0, 0);
  const weekEnd = new Date(weekStart);
  weekEnd.setDate(weekStart.getDate() + 6);
  weekEnd.setHours(23, 59, 59, 999);
  // Filter events that occur within this calendar week
  // Collect events within the current calendar week
  const weeklyEvents = getVisibleEvents().filter(ev => {
    // Exclude archived events
    if (ev.status === 'done') return false;
    const d = new Date(ev.date + 'T00:00:00');
    return d >= weekStart && d <= weekEnd;
  }).sort((a,b) => a.date.localeCompare(b.date) || (a.time||'').localeCompare(b.time||''));
  // Collapse events across the week so multi‑day tasks are shown once with a range.
  const collapsedRange = collapseEvents(weeklyEvents);
  // Collect tasks that have a due date within the current week. Exclude completed tasks.
  const weeklyTasks = getVisibleTasks().filter(t => {
    if (!t.dueDate || t.status === 'done') return false;
    const due = toDateTime(t.dueDate, t.time);
    return due && due >= weekStart && due <= weekEnd;
  });
  // Unique clients appearing via events or tasks this week
  const taskClientIds = new Set(weeklyTasks.map(t => t.clientId));
  const eventClientIds = new Set(collapsedRange.map(ev => ev.clientId));
  const clientsThisWeek = Array.from(new Set([...eventClientIds, ...taskClientIds]));
  // Events occurring today
  const todayString = todayISO();
  const todayEvents = getVisibleEvents().filter(e => e.date === todayString && e.status !== 'done').sort((a,b) => (a.time || '').localeCompare(b.time || ''));

  // Stats cards: Clients this week, Weekly tasks, Today's tasks
  const stats = document.createElement('div');
  stats.className = 'grid grid-cols-1 md:grid-cols-3 gap-4';

  // Overdue items card: include tasks and events whose date/dueDate is before today and not done
  const todayStart = new Date();
  todayStart.setHours(0,0,0,0);
  const overdueItems = [];
  // tasks
  getVisibleTasks().forEach(t => {
    if (!t.dueDate || t.status === 'done') return;
    const due = new Date(t.dueDate + 'T00:00:00');
    if (due < todayStart) overdueItems.push({ type:'task', obj: t });
  });
  // events
  getVisibleEvents().forEach(ev => {
    if (ev.status === 'done') return;
    const evDate = new Date(ev.date + 'T00:00:00');
    if (evDate < todayStart) overdueItems.push({ type:'event', obj: ev });
  });
  if (overdueItems.length > 0) {
    const overdueCard = document.createElement('div');
    overdueCard.className = 'bg-white rounded-2xl p-4 shadow-sm border border-red-200';
    overdueCard.innerHTML = '<div class="text-sm font-medium text-red-600">Overdue items</div>';
    const ul = document.createElement('ul');
    ul.className = 'mt-2 space-y-1';
    overdueItems.forEach(entry => {
      if (entry.type === 'task') {
        const task = entry.obj;
        const client = state.clients.find(c => c.id === task.clientId) || { name:'Unknown', color:'#999' };
        const phase = task.phase || 'None';
        const badgeClass = phase === 'Scripting' ? 'bg-red-100 text-red-700' : (phase === 'Filming' ? 'bg-blue-100 text-blue-700' : 'bg-gray-200 text-gray-700');
        const li = document.createElement('li');
        li.className = 'flex items-start gap-2 text-sm';
        const suffix = assigneeSuffix(task.assignee);
        li.innerHTML = '<span class="inline-block w-2 h-2 mt-1 rounded-full" style="background:' + client.color + '"></span>' +
          '<span class="px-1.5 py-0.5 rounded ' + badgeClass + ' text-xs mr-1">' + (phase === 'None' ? 'N' : phase.charAt(0)) + '</span>' +
          '<div class="flex-1"><div class="font-medium">' + client.name + ' • ' + task.title + suffix + '</div><div class="text-xs text-zinc-500">Due ' + fmtDate(task.dueDate) + '</div></div>' +
          '<div class="flex items-center gap-2 ml-auto"><button onclick="openCompletionPrompt(\'task\', \'' + task.id + '\')" class="p-1 rounded hover:bg-zinc-200">✔</button><button onclick="openTaskOptions(\'' + task.id + '\', event)" class="p-1 rounded hover:bg-zinc-200">⋯</button></div>';
        ul.appendChild(li);
      } else {
        const ev = entry.obj;
        const client = state.clients.find(c => c.id === ev.clientId) || { name:'Unknown', color:'#999' };
        const phase = ev.phase || '';
        const badgeClass = phase === 'Scripting' ? 'bg-red-100 text-red-700' : (phase === 'Filming' ? 'bg-blue-100 text-blue-700' : 'bg-gray-200 text-gray-700');
        const rangeText = ev.endDate && ev.endDate !== ev.date ? (fmtDate(ev.date) + ' – ' + fmtDate(ev.endDate)) : fmtDate(ev.date);
        const li = document.createElement('li');
        li.className = 'flex items-start gap-2 text-sm';
        const suffixEv = assigneeSuffix(ev.assignee);
        li.innerHTML = '<span class="inline-block w-2 h-2 mt-1 rounded-full" style="background:' + client.color + '"></span>' +
          '<span class="px-1.5 py-0.5 rounded ' + badgeClass + ' text-xs mr-1">' + (phase ? phase.charAt(0) : 'E') + '</span>' +
          '<div class="flex-1"><div class="font-medium">' + client.name + ' • ' + ev.title + suffixEv + '</div><div class="text-xs text-zinc-500">' + rangeText + '</div></div>' +
          '<div class="flex items-center gap-2 ml-auto"><button onclick="openCompletionPrompt(\'event\', \'' + ev.id + '\')" class="p-1 rounded hover:bg-zinc-200">✔</button><button onclick="openEventOptions(\'' + ev.id + '\')" class="p-1 rounded hover:bg-zinc-200">⋯</button></div>';
        ul.appendChild(li);
      }
    });
    overdueCard.appendChild(ul);
    container.appendChild(overdueCard);
  }

  // Clients this week card
  const clientsCard = document.createElement('div');
  clientsCard.className = 'bg-white rounded-2xl p-4 shadow-sm';
  clientsCard.innerHTML = '<div class="text-sm text-zinc-500">Clients this week</div>';
  if (clientsThisWeek.length === 0) {
    clientsCard.innerHTML += '<div class="text-sm text-zinc-500 mt-2">No clients</div>';
  } else {
    const ul = document.createElement('ul');
    ul.className = 'mt-2 space-y-1';
    clientsThisWeek.forEach(cid => {
      const client = state.clients.find(c => c.id === cid);
      if (!client) return;
      // Compute days left until the next due item (task or event) for this client.
      // The helper returns a negative number for overdue tasks and a positive number for upcoming items.
      const _dLeft = nextDaysLeftForClient(cid);
      let daysLeft = '';
      if (_dLeft !== null) {
        // Append appropriate suffix depending on whether the date is past or upcoming
        if (_dLeft < 0) {
          daysLeft = Math.abs(_dLeft) + 'd late';
        } else {
          daysLeft = _dLeft + 'd left';
        }
      }
      const li = document.createElement('li');
      li.className = 'flex items-center gap-2 text-sm';
      li.innerHTML = '<span class="inline-block w-2 h-2 rounded-full" style="background:' + client.color + '"></span>' +
        '<span>' + client.name + (daysLeft ? ' • ' + daysLeft : '') + '</span>';
      ul.appendChild(li);
    });
    clientsCard.appendChild(ul);
  }
  stats.appendChild(clientsCard);

  // Weekly tasks card: show both events and due tasks within this week.
  const weeklyCard = document.createElement('div');
  weeklyCard.className = 'bg-white rounded-2xl p-4 shadow-sm';
  weeklyCard.innerHTML = '<div class="text-sm text-zinc-500">Weekly tasks</div>';
  // Build a combined list of event-like objects: include real events and tasks due this week
  const combined = [];
  collapsedRange.forEach(ev => {
    combined.push({
      type: 'event',
      id: ev.id,
      clientId: ev.clientId,
      title: ev.title,
      date: ev.date,
      endDate: ev.endDate,
      time: ev.time
    });
  });
  weeklyTasks.forEach(t => {
    combined.push({
      type: 'task',
      id: t.id,
      clientId: t.clientId,
      title: t.title,
      date: t.dueDate,
      endDate: t.dueDate,
      time: t.time,
      status: t.status
    });
  });
  // Sort combined by date then time
  combined.sort((a,b) => {
    if (a.date === b.date) {
      return (a.time || '').localeCompare(b.time || '');
    }
    return a.date.localeCompare(b.date);
  });
  if (combined.length === 0) {
    weeklyCard.innerHTML += '<div class="text-sm text-zinc-500 mt-2">No tasks</div>';
  } else {
    const ul = document.createElement('ul');
    ul.className = 'mt-2 space-y-1';
    combined.forEach(item => {
      const client = state.clients.find(c => c.id === item.clientId) || { color:'#999', name:'Unknown' };
      const li = document.createElement('li');
      li.className = 'flex items-start gap-2 text-sm';
      // Determine range text for events; tasks use days-left/late
      const rangeText = item.endDate && item.endDate !== item.date ? (fmtDate(item.date) + ' – ' + fmtDate(item.endDate)) : fmtDate(item.date);
      if (item.type === 'task') {
        const task = (state.tasks || []).find(t => t.id === item.id) || {};
        const phase = task.phase || 'None';
        const badgeClass = phase === 'Scripting' ? 'bg-red-100 text-red-700' : (phase === 'Filming' ? 'bg-blue-100 text-blue-700' : 'bg-gray-200 text-gray-700');
        const due = new Date(item.date + 'T00:00:00');
        const startOfToday = new Date(todayISO() + 'T00:00:00');
        let diff = Math.floor((due - startOfToday) / (24*60*60*1000));
        let dayLabel;
        if (diff < 0) {
          dayLabel = Math.abs(diff) + 'd late';
        } else if (diff === 0) {
          dayLabel = 'Do today';
        } else if (diff === 1) {
          dayLabel = 'Do tomorrow';
        } else {
          dayLabel = diff + 'd left';
        }
        // Compute suffix to show assignment (You or employee name) for this task
        const suffix = assigneeSuffix(task.assignee);
        li.innerHTML = '<span class="inline-block w-2 h-2 mt-1 rounded-full" style="background:' + client.color + '"></span>' +
          '<span class="px-1.5 py-0.5 rounded ' + badgeClass + ' text-xs mr-1">' + (phase === 'None' ? 'N' : phase.charAt(0)) + '</span>' +
          '<div class="flex-1"><div class="font-medium">' + client.name + ' • ' + item.title + suffix + '</div><div class="text-xs text-zinc-500">' + dayLabel + '</div></div>' +
          '<div class="flex items-center gap-2 ml-auto"><button onclick="openCompletionPrompt(\'task\', \'' + item.id + '\')" class="p-1 rounded hover:bg-zinc-200">✔</button><button onclick="openTaskOptions(\'' + item.id + '\', event)" class="p-1 rounded hover:bg-zinc-200">⋯</button></div>';
        // Clicking anywhere on the task row (except action buttons) opens the edit modal
        li.addEventListener('click', function(e) {
          if (e.target.closest('button')) return;
          openEditTaskModal(item.id);
        });
        // Enable dragging of tasks from the weekly list. Set dataTransfer payload so dropping onto the calendar moves it.
        li.setAttribute('draggable', 'true');
        li.addEventListener('dragstart', e => {
          try { e.dataTransfer.setData('application/json', JSON.stringify({ type:'task', id: item.id })); }
          catch(err) {}
        });
        ul.appendChild(li);
      } else {
        // Event: show range; include phase badge; show check and triple-dot controls
        const evObj = state.events.find(e => e.id === item.id) || {};
        const phase = evObj.phase || '';
        const badgeClass = phase === 'Scripting' ? 'bg-red-100 text-red-700' : (phase === 'Filming' ? 'bg-blue-100 text-blue-700' : 'bg-gray-200 text-gray-700');
        // Compute suffix for event assignment
        const suffixEv = assigneeSuffix(evObj.assignee);
        li.innerHTML = '<span class="inline-block w-2 h-2 mt-1 rounded-full" style="background:' + client.color + '"></span>' +
          '<span class="px-1.5 py-0.5 rounded ' + badgeClass + ' text-xs mr-1">' + (phase ? phase.charAt(0) : 'E') + '</span>' +
          '<div class="flex-1"><div class="font-medium">' + client.name + ' • ' + item.title + suffixEv + '</div><div class="text-xs text-zinc-500">' + rangeText + '</div></div>' +
          '<div class="flex items-center gap-2 ml-auto"><button onclick="openCompletionPrompt(\'event\', \'' + item.id + '\')" class="p-1 rounded hover:bg-zinc-200">✔</button><button onclick="openEventOptions(\'' + item.id + '\')" class="p-1 rounded hover:bg-zinc-200">⋯</button></div>';
        // Clicking anywhere on the event row (except action buttons) opens the options menu (assign/edit)
        li.addEventListener('click', function(e) {
          if (e.target.closest('button')) return;
          openEventOptions(item.id);
        });
        // Enable dragging of events from the weekly list. Set dataTransfer payload to allow dropping onto date cells.
        li.setAttribute('draggable', 'true');
        li.addEventListener('dragstart', e => {
          try { e.dataTransfer.setData('application/json', JSON.stringify({ type:'event', id: item.id })); }
          catch(err) {}
        });
        ul.appendChild(li);
      }
    });
    weeklyCard.appendChild(ul);
  }
  // Enable dropping tasks or events onto the weekly tasks card. If a task is dropped, open
  // the edit modal so the user can choose a new due date. If an event is dropped,
  // open the event edit modal. This allows dragging items from the Today list or
  // calendar back into the weekly list to reschedule them.
  weeklyCard.addEventListener('dragover', e => {
    e.preventDefault();
  });
  weeklyCard.addEventListener('drop', e => {
    e.preventDefault();
    const data = e.dataTransfer.getData('application/json');
    if (!data) return;
    let obj;
    try { obj = JSON.parse(data); } catch(err) { return; }
    if (obj.type === 'task') {
      openEditTaskModal(obj.id);
    } else if (obj.type === 'event') {
      const ev = state.events.find(ev => ev.id === obj.id);
      if (ev) openEditEventModal(ev);
    }
  });
  stats.appendChild(weeklyCard);

  // Today's tasks/events card: combine tasks due today and events today
  const dailyCard = document.createElement('div');
  dailyCard.className = 'bg-white rounded-2xl p-4 shadow-sm';
  dailyCard.innerHTML = '<div class="text-sm text-zinc-500">Today</div>';
  // Filter tasks and events due today and not completed. Only include items visible to the current user.
  const tasksToday = getVisibleTasks().filter(t => t.dueDate === todayString && t.status !== 'done');
  const eventsToday = getVisibleEvents().filter(e => e.date === todayString && e.status !== 'done');
  const allToday = [];
  tasksToday.forEach(t => allToday.push({ type:'task', obj: t }));
  eventsToday.forEach(ev => allToday.push({ type:'event', obj: ev }));
  // sort by time (tasks without time sort first) then by title
  allToday.sort((a,b) => {
    const ta = a.obj.time || '';
    const tb = b.obj.time || '';
    if (ta === tb) return a.obj.title.localeCompare(b.obj.title);
    return ta.localeCompare(tb);
  });
  if (allToday.length === 0) {
    dailyCard.innerHTML += '<div class="text-sm text-zinc-500 mt-2">No tasks</div>';
  } else {
    const ul = document.createElement('ul');
    ul.className = 'mt-2 space-y-1';
    allToday.forEach(entry => {
      if (entry.type === 'task') {
        const t = entry.obj;
        const client = state.clients.find(c => c.id === t.clientId) || { color:'#999', name:'Unknown' };
        const phase = t.phase || 'None';
        const badgeClass = phase === 'Scripting' ? 'bg-red-100 text-red-700' : (phase === 'Filming' ? 'bg-blue-100 text-blue-700' : 'bg-gray-200 text-gray-700');
        const li = document.createElement('li');
        li.className = 'flex items-start gap-2 text-sm';
        const timeLabel = t.time ? t.time : '(All day)';
        // Include assignment suffix for tasks due today
        const suffix = assigneeSuffix(t.assignee);
      li.innerHTML = '<span class="inline-block w-2 h-2 mt-1 rounded-full" style="background:' + client.color + '"></span>' +
          '<span class="px-1.5 py-0.5 rounded ' + badgeClass + ' text-xs mr-1">' + (phase === 'None' ? 'N' : phase.charAt(0)) + '</span>' +
          '<div class="flex-1"><div class="font-medium">' + client.name + ' • ' + t.title + suffix + '</div><div class="text-xs text-zinc-500">' + timeLabel + '</div></div>' +
          '<div class="flex items-center gap-2 ml-auto"><button onclick="openCompletionPrompt(\'task\', \'' + t.id + '\')" class="p-1 rounded hover:bg-zinc-200">✔</button><button onclick="openTaskOptions(\'' + t.id + '\', event)" class="p-1 rounded hover:bg-zinc-200">⋯</button></div>';
        // Enable dragging of today tasks so they can be moved to another day or weekly list.
        li.setAttribute('draggable', 'true');
        li.addEventListener('dragstart', e => {
          try { e.dataTransfer.setData('application/json', JSON.stringify({ type:'task', id: t.id })); }
          catch(err) {}
        });
        // Clicking on the row (except action buttons) opens the edit modal for the task
        li.addEventListener('click', (clk) => {
          if (clk.target.closest('button')) return;
          openEditTaskModal(t.id);
        });
        ul.appendChild(li);
      } else {
        const ev = entry.obj;
        const client = state.clients.find(c => c.id === ev.clientId) || { color:'#999', name:'Unknown' };
        const phase = ev.phase || '';
        const badgeClass = phase === 'Scripting' ? 'bg-red-100 text-red-700' : (phase === 'Filming' ? 'bg-blue-100 text-blue-700' : 'bg-gray-200 text-gray-700');
        const li = document.createElement('li');
        li.className = 'flex items-start gap-2 text-sm';
        const timeLabel = ev.allDay ? '(All day)' : (ev.time || '—');
        // Include suffix for events due today
        const suffixEv = assigneeSuffix(ev.assignee);
        li.innerHTML = '<span class="inline-block w-2 h-2 mt-1 rounded-full" style="background:' + client.color + '"></span>' +
          '<span class="px-1.5 py-0.5 rounded ' + badgeClass + ' text-xs mr-1">' + (phase ? phase.charAt(0) : 'E') + '</span>' +
          '<div class="flex-1"><div class="font-medium">' + client.name + ' • ' + ev.title + suffixEv + '</div><div class="text-xs text-zinc-500">' + timeLabel + '</div></div>' +
          '<div class="flex items-center gap-2 ml-auto"><button onclick="openCompletionPrompt(\'event\', \'' + ev.id + '\')" class="p-1 rounded hover:bg-zinc-200">✔</button><button onclick="openEventOptions(\'' + ev.id + '\')" class="p-1 rounded hover:bg-zinc-200">⋯</button></div>';
        // Enable dragging of today events so they can be moved to another day or weekly list.
        li.setAttribute('draggable', 'true');
        li.addEventListener('dragstart', e => {
          try { e.dataTransfer.setData('application/json', JSON.stringify({ type:'event', id: ev.id })); }
          catch(err) {}
        });
        // Clicking anywhere on the event row (except action buttons) opens the options menu
        li.addEventListener('click', (evclick) => {
          if (evclick.target.closest('button')) return;
          openEventOptions(ev.id);
        });
        ul.appendChild(li);
      }
    });
    dailyCard.appendChild(ul);
  }
  stats.appendChild(dailyCard);

  container.appendChild(stats);

  // Schedule & calendar section with range controls
  const schedSec = document.createElement('section');
  schedSec.className = 'bg-white rounded-2xl p-4 shadow-sm';
  // Header with range buttons
  const schedHeader = document.createElement('div');
  schedHeader.className = 'flex items-center justify-between mb-3';
  schedHeader.innerHTML = '<h3 class="font-semibold">Schedule</h3>';
  const rangeBtns = document.createElement('div');
  rangeBtns.className = 'flex gap-2';
  const rangeOptions = [
    { label: 'Week', days: 7 },
    { label: 'Bi-weekly', days: 14 },
    { label: 'Monthly', days: 30 },
    { label: '3 months', days: 90 },
    { label: '6 months', days: 180 },
    { label: 'All', days: null }
  ];
  rangeOptions.forEach(o => {
    const b = document.createElement('button');
    b.className = 'px-3 py-2 rounded-xl text-sm ' + (state.rangeDays === o.days ? 'bg-black text-white' : 'bg-zinc-100 hover:bg-zinc-200');
    b.textContent = o.label;
    b.onclick = () => {
      state.rangeDays = o.days;
      saveState();
      render();
    };
    rangeBtns.appendChild(b);
  });
  schedHeader.appendChild(rangeBtns);
  schedSec.appendChild(schedHeader);
  // Calendar for selected range.
  // For month view (range null or >=30), render a month calendar and include navigation controls here.
  if (!state.rangeDays || state.rangeDays >= 30) {
    // compute month to display based on offset
    const baseMonth = new Date();
    baseMonth.setDate(1);
    const displayMonth = new Date(baseMonth.getFullYear(), baseMonth.getMonth() + state.monthOffset, 1);
    // navigation row
    const navRow = document.createElement('div');
    navRow.className = 'flex items-center justify-between mb-2';
    const prevBtn = document.createElement('button');
    prevBtn.className = 'px-3 py-1 rounded-xl bg-zinc-100 hover:bg-zinc-200';
    prevBtn.textContent = '←';
    prevBtn.onclick = () => {
      state.monthOffset--;
      // Persist month offset so navigating between tabs retains month view
      saveState();
      render();
    };
    const nextBtn = document.createElement('button');
    nextBtn.className = 'px-3 py-1 rounded-xl bg-zinc-100 hover:bg-zinc-200';
    nextBtn.textContent = '→';
    nextBtn.onclick = () => {
      state.monthOffset++;
      saveState();
      render();
    };
    const label = document.createElement('div');
    label.className = 'font-medium';
    label.textContent = monthLabel(displayMonth);
    navRow.appendChild(prevBtn);
    navRow.appendChild(label);
    navRow.appendChild(nextBtn);
    schedSec.appendChild(navRow);
    // append the month calendar
    schedSec.appendChild(renderOverviewMonth(displayMonth));
  } else {
    // range-based view
    schedSec.appendChild(renderOverviewRangeCalendar(state.rangeDays));
  }
  container.appendChild(schedSec);
  return container;
}
function deleteEvent(id) {
  state.events = state.events.filter(e => e.id !== id);
  saveState();
  render();
}
function renderOverviewMonth(monthDate) {
  const y = monthDate.getFullYear();
  const m = monthDate.getMonth();
  const start = new Date(y, m, 1);
  const startDay = start.getDay();
  const daysInMonth = new Date(y, m+1, 0).getDate();
  const grid = [];
  for (let i=0; i<startDay; i++) grid.push(null);
  for (let d=1; d<=daysInMonth; d++) grid.push(new Date(y,m,d));
  while (grid.length % 7 !== 0) grid.push(null);
  // Use the visible events when populating the month view. This ensures that
  // employees only see events assigned to them while the manager sees all events.
  const eventsByDay = iso => {
    // Filter by visibility and status/due date
    return getVisibleEvents().filter(e => e.date === iso && e.status !== 'done').sort((a,b) => {
      if (a.allDay === b.allDay) return (a.time||'').localeCompare(b.time||'');
      return a.allDay ? -1 : 1;
    });
  };
  const toISO = d => d.toISOString().slice(0,10);
  const container = document.createElement('div');
  const daysRow = document.createElement('div');
  daysRow.className = 'grid grid-cols-7 gap-2 text-xs font-medium text-zinc-500 mb-2';
  ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d => {
    const el = document.createElement('div');
    el.className = 'text-center';
    el.textContent = d;
    daysRow.appendChild(el);
  });
  container.appendChild(daysRow);
  const gridEl = document.createElement('div');
  gridEl.className = 'grid grid-cols-7 gap-2';
    grid.forEach(d => {
    if (!d) {
      const div = document.createElement('div');
      div.className = 'h-28 bg-zinc-100 dark:bg-zinc-800 rounded-xl';
      gridEl.appendChild(div);
      return;
    }
    const iso = toISO(d);
    const items = eventsByDay(iso);
    const cell = document.createElement('div');
    cell.setAttribute('data-date', iso);
    const isToday = iso === todayISO();
    // Determine if this date falls within any client's onboarding range (onboardDate to +14 days)
    let isInOnboarding = false;
    state.clients.forEach(c => {
      if (c.onboardDate) {
        const start = new Date(c.onboardDate + 'T00:00:00');
        const end = new Date(start.getTime() + 14 * 24 * 60 * 60 * 1000);
        const current = new Date(iso + 'T00:00:00');
        if (current >= start && current <= end) {
          isInOnboarding = true;
        }
      }
    });
    cell.className = 'h-28 rounded-xl border ' + (isToday ? 'border-black' : 'border-zinc-200 dark:border-zinc-800') + ' bg-white dark:bg-zinc-900 p-2 flex flex-col';
    if (isInOnboarding) {
      cell.classList.add('shade-onboard');
    }
    const top = document.createElement('div');
    top.className = 'flex items-center justify-between mb-1';
    top.innerHTML = '<div class="text-xs text-zinc-500">' + d.getDate() + '</div>';
    cell.appendChild(top);
    const list = document.createElement('div');
    list.className = 'space-y-1 overflow-auto pr-1';
    items.forEach(ev => {
      const client = state.clients.find(c=>c.id===ev.clientId) || { name:'Unknown', color:'#999' };
      const row = document.createElement('div');
      row.className = 'text-xs px-2 py-1 rounded-lg border flex items-center gap-2 cursor-pointer';
      row.style.borderColor = client.color;
      // Phase badge
      const phase = ev.phase || '';
      const badgeSpan = document.createElement('span');
      badgeSpan.className = 'px-1.5 py-0.5 rounded ' + (phase==='Scripting' ? 'bg-red-100 text-red-700' : (phase==='Filming' ? 'bg-blue-100 text-blue-700' : 'bg-gray-200 text-gray-700'));
      badgeSpan.textContent = phase ? phase.charAt(0) : 'E';
      row.appendChild(badgeSpan);
      const titleSpan = document.createElement('span');
      titleSpan.className = 'font-medium flex-1';
      // Append the assignee suffix (e.g. "(You)" or employee name) to clearly
      // indicate which employee this event belongs to. Without this, employees
      // might not know if an entry is theirs when viewing the calendar.
      titleSpan.textContent = client.name + ' • ' + ev.title + assigneeSuffix(ev.assignee);
      row.appendChild(titleSpan);
      // Control buttons: complete and edit
      const controls = document.createElement('div');
      controls.className = 'flex items-center gap-1 ml-auto';
      const chk = document.createElement('button');
      chk.className = 'p-1 rounded hover:bg-zinc-200';
      chk.textContent = '✔';
      chk.addEventListener('click', (e) => {
        e.stopPropagation();
        completeEvent(ev.id);
      });
      const menu = document.createElement('button');
      menu.className = 'p-1 rounded hover:bg-zinc-200';
      menu.textContent = '⋯';
      menu.addEventListener('click', (e) => {
        e.stopPropagation();
        // Pass the click event so the menu can be positioned correctly
        openEventOptions(ev.id, e);
      });
      controls.appendChild(chk);
      controls.appendChild(menu);
      row.appendChild(controls);
      row.addEventListener('click', () => {
        highlightCalendarRange(ev.date, ev.endDate || ev.date);
      });
      // Enable dragging of events within the overview month view. Store the
      // event id and type in the dataTransfer payload for drop handlers.
      row.setAttribute('draggable', 'true');
      row.addEventListener('dragstart', e => {
        try { e.dataTransfer.setData('application/json', JSON.stringify({ type:'event', id: ev.id })); }
        catch(err) {}
      });
      list.appendChild(row);
    });
    // Render tasks that span this day (between startDate and dueDate, inclusive)
    // Use getVisibleTasks() to ensure employees only see their own assignments.
    const dayTasks = (getVisibleTasks() || []).filter(t => {
      if (t.status === 'done') return false;
      const s = t.startDate || t.dueDate;
      const e = t.dueDate || t.startDate;
      if (!s || !e) return false;
      return s <= iso && e >= iso;
    });
    dayTasks.forEach(t => {
      const client = state.clients.find(c => c.id === t.clientId) || { name:'Unknown', color:'#999' };
      const row = document.createElement('div');
      row.className = 'text-xs px-2 py-1 rounded-lg border flex items-center gap-2 cursor-pointer';
      row.style.borderColor = client.color;
      const phase = t.phase || 'None';
      const badgeSpan = document.createElement('span');
      badgeSpan.className = 'px-1.5 py-0.5 rounded ' + (phase === 'Scripting' ? 'bg-red-100 text-red-700' : (phase === 'Filming' ? 'bg-blue-100 text-blue-700' : 'bg-gray-200 text-gray-700'));
      badgeSpan.textContent = (phase === 'None' ? 'N' : phase.charAt(0));
      row.appendChild(badgeSpan);
      const titleSpan = document.createElement('span');
      titleSpan.className = 'font-medium flex-1';
      // Append the assignee suffix so that the calendar clearly reflects who
      // each task belongs to. The suffix displays "(You)" for the current
      // employee or the assignee name for other employees.
      titleSpan.textContent = client.name + ' • ' + t.title + assigneeSuffix(t.assignee);
      row.appendChild(titleSpan);
      // controls: check & menu
      const controls = document.createElement('div');
      controls.className = 'flex items-center gap-1 ml-auto';
      const chk = document.createElement('button');
      chk.className = 'p-1 rounded hover:bg-zinc-200';
      chk.textContent = '✔';
      chk.addEventListener('click', (e) => {
        e.stopPropagation();
        openCompletionPrompt('task', t.id);
      });
      const menu = document.createElement('button');
      menu.className = 'p-1 rounded hover:bg-zinc-200';
      menu.textContent = '⋯';
      menu.addEventListener('click', (e) => {
        e.stopPropagation();
        // Pass the click event to openTaskOptions so it can position the menu properly
        openTaskOptions(t.id, e);
      });
      controls.appendChild(chk);
      controls.appendChild(menu);
      row.appendChild(controls);
      row.addEventListener('click', (e) => {
        // Highlight the task range when clicked and show popover
        const startIso = t.startDate || t.dueDate;
        const endIso = t.dueDate || t.startDate;
        highlightCalendarRange(startIso, endIso);
        openTaskPopover(t.id, row);
        e.stopPropagation();
      });
      // Enable dragging of tasks within the overview month view. Set a
      // dataTransfer payload containing the task id for drop handlers.
      row.setAttribute('draggable', 'true');
      row.addEventListener('dragstart', e => {
        try { e.dataTransfer.setData('application/json', JSON.stringify({ type:'task', id: t.id })); }
        catch(err) {}
      });
      list.appendChild(row);
    });
    cell.appendChild(list);
    // Allow dropping tasks or events onto this date. When a draggable item is
    // dropped, update the item date accordingly and re‑render.
    cell.addEventListener('dragover', e => {
      e.preventDefault();
    });
    cell.addEventListener('drop', e => {
      e.preventDefault();
      const data = e.dataTransfer.getData('application/json');
      if (!data) return;
      let obj;
      try { obj = JSON.parse(data); } catch(err) { return; }
      const targetIso = cell.getAttribute('data-date');
      if (!targetIso) return;
      if (obj.type === 'task') {
        moveTask(obj.id, targetIso);
      } else if (obj.type === 'event') {
        moveEvent(obj.id, targetIso);
      }
      saveState();
      render();
    });
    gridEl.appendChild(cell);
  });
  container.appendChild(gridEl);
  return container;
}

// Render a calendar for a custom range of days starting today. If rangeDays is null or >=30, falls back to a monthly calendar.
function renderOverviewRangeCalendar(rangeDays) {
  const today = new Date();
  // Use local midnight for the start date to avoid timezone offset issues that shift
  // weekly range by one day. Construct date using year, month, date instead of
  // toISOString().slice(0,10) which is UTC-based.
  const startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
  // If no range specified or range is large (monthly or more), show the standard month view
  if (!rangeDays || rangeDays >= 30) {
    const month = new Date(startDate);
    month.setDate(1);
    return renderOverviewMonth(month);
  }
  // Build an array of dates for the specified range
  const dates = [];
  for (let i = 0; i < rangeDays; i++) {
    const d = new Date(startDate);
    d.setDate(startDate.getDate() + i);
    dates.push(d);
  }
  // Pad the dates array so total cells is a multiple of 7
  while (dates.length % 7 !== 0) {
    dates.push(null);
  }
  const container = document.createElement('div');
  // Days row (Sun–Sat)
  const daysRow = document.createElement('div');
  daysRow.className = 'grid grid-cols-7 gap-2 text-xs font-medium text-zinc-500 mb-2';
  ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d => {
    const el = document.createElement('div');
    el.className = 'text-center';
    el.textContent = d;
    daysRow.appendChild(el);
  });
  container.appendChild(daysRow);
  // Grid of date cells
  const gridEl = document.createElement('div');
  gridEl.className = 'grid grid-cols-7 gap-2';
  // Precompute onboarding and halfway dates from all clients for shading
  const onboardDates = {};
  const halfwayDates = {};
  state.clients.forEach(c => {
    if (c.onboardDate) {
      onboardDates[c.onboardDate] = true;
      const start = new Date(c.onboardDate + 'T00:00:00');
      const half = new Date(start.getTime() + 14 * 24 * 60 * 60 * 1000);
      const halfIso = half.toISOString().slice(0, 10);
      halfwayDates[halfIso] = true;
    }
  });
  dates.forEach(d => {
    if (!d) {
      const blank = document.createElement('div');
      blank.className = 'h-28 bg-zinc-100 rounded-xl';
      gridEl.appendChild(blank);
      return;
    }
    const iso = d.toISOString().slice(0, 10);
    const items = state.events.filter(e => e.date === iso && e.status !== 'done').sort((a, b) => {
      if (a.allDay === b.allDay) return (a.time || '').localeCompare(b.time || '');
      return a.allDay ? -1 : 1;
    });
    const cell = document.createElement('div');
    const isToday = iso === todayISO();
    cell.className = 'h-28 rounded-xl border ' + (isToday ? 'border-black' : 'border-zinc-200') + ' bg-white p-2 flex flex-col';
    // Apply shading if this date matches onboarding or halfway markers
    if (onboardDates[iso]) {
      cell.style.cssText += 'background-color:#fef3c7;';
    } else if (halfwayDates[iso]) {
      cell.style.cssText += 'background-color:#e0f7fa;';
    }
    // Top bar with date
    const top = document.createElement('div');
    top.className = 'flex items-center justify-between mb-1';
    top.innerHTML = '<div class="text-xs text-zinc-500">' + d.getDate() + '</div>';
    cell.appendChild(top);
    // Events list
    const list = document.createElement('div');
    list.className = 'space-y-1 overflow-auto pr-1';
    items.forEach(ev => {
      const client = state.clients.find(c => c.id === ev.clientId) || { name:'Unknown', color:'#999' };
      const item = document.createElement('div');
      item.className = 'text-xs px-2 py-1 rounded-lg border flex items-center gap-2';
      item.style.borderColor = client.color;
      item.innerHTML = '<span class="px-1.5 py-0.5 rounded ' + (ev.phase==='Scripting' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700') + '">' + ev.phase.charAt(0) + '</span>' +
        '<span class="font-medium flex-1">' + client.name + ' • ' + ev.title + '</span>' +
        '<button onclick="openDeleteEventConfirm(\'' + ev.id + '\')" class="p-1 rounded hover:bg-zinc-200">🗑</button>';
      list.appendChild(item);
    });
    // Add tasks that span this day to the range calendar
    const dayTasks = (state.tasks || []).filter(t => {
      if (t.status === 'done') return false;
      const s = t.startDate || t.dueDate;
      const e = t.dueDate || t.startDate;
      if (!s || !e) return false;
      return s <= iso && e >= iso;
    });
    dayTasks.forEach(t => {
      const client = state.clients.find(c => c.id === t.clientId) || { name:'Unknown', color:'#999' };
      const phase = t.phase || 'None';
      const badgeClass = phase === 'Scripting' ? 'bg-red-100 text-red-700' : (phase === 'Filming' ? 'bg-blue-100 text-blue-700' : 'bg-gray-200 text-gray-700');
      const row = document.createElement('div');
      row.className = 'text-xs px-2 py-1 rounded-lg border flex items-center gap-2 cursor-pointer';
      row.style.borderColor = client.color;
      row.innerHTML = '<span class="px-1.5 py-0.5 rounded ' + badgeClass + '">' + (phase === 'None' ? 'N' : phase.charAt(0)) + '</span>' +
        '<span class="font-medium flex-1">' + client.name + ' • ' + t.title + '</span>' +
        '<div class="flex items-center gap-1 ml-auto"><button onclick="openCompletionPrompt(\'task\', \'' + t.id + '\')" class="p-1 rounded hover:bg-zinc-200">✔</button><button onclick="openTaskOptions(\'' + t.id + '\', event)" class="p-1 rounded hover:bg-zinc-200">⋯</button></div>';
      row.addEventListener('click', (e) => {
        const startIso = t.startDate || t.dueDate;
        const endIso = t.dueDate || t.startDate;
        highlightCalendarRange(startIso, endIso);
        openTaskPopover(t.id, row);
        e.stopPropagation();
      });
      list.appendChild(row);
    });
    cell.appendChild(list);
    gridEl.appendChild(cell);
  });
  container.appendChild(gridEl);
  return container;
}

// ==== Clients Page ====
function renderClientsPage() {
  const container = document.createElement('div');
  container.className = 'space-y-6';
  const header = document.createElement('div');
  header.className = 'flex items-center justify-between flex-wrap gap-2';
  // Title and actions: include both Add Client and Employees management. We wrap buttons in a flex container
  header.innerHTML =
    '<h2 class="text-2xl font-semibold">Clients</h2>' +
    '<div class="flex items-center gap-2 ml-auto">' +
      // Button to add a new client
      '<button onclick="openAddClientModal()" class="inline-flex items-center gap-2 px-4 py-2 rounded-2xl bg-black text-white hover:opacity-90"><span class="w-4 h-4 inline-block">＋</span> Add Client</button>' +
      // Button to navigate to the Employees management tab. This allows quick access to add/edit employees from the Clients page.
      '<button onclick="setTab(\'Employees\')" class="inline-flex items-center gap-2 px-4 py-2 rounded-2xl bg-zinc-100 text-zinc-800 hover:bg-zinc-200 border border-zinc-200">' +
        '<span class="w-4 h-4 inline-block">👥</span> Employees' +
      '</button>' +
    '</div>';
  container.appendChild(header);
  const chips = document.createElement('div');
  chips.className = 'flex gap-2 overflow-x-auto pb-2';
  state.clients.forEach(c => {
    const isActive = state.activeClientId === c.id;
    const chip = document.createElement('div');
    chip.className = 'flex items-center gap-2 px-3 py-2 rounded-2xl border ' + (isActive?'bg-white border-zinc-300 shadow':'bg-zinc-100 border-zinc-200');
    chip.innerHTML = '<button onclick="setActiveClient(\'' + c.id + '\')" class="flex items-center gap-2"><span class="inline-block w-3 h-3 rounded-full" style="background:' + c.color + '"></span><span class="font-semibold text-zinc-900 whitespace-nowrap">' + c.name + '</span></button>' +
      '<button onclick="openDeleteClientConfirm(\'' + c.id + '\')" class="p-2 rounded-xl hover:bg-zinc-200">⋮</button>';
    chips.appendChild(chip);
  });
  container.appendChild(chips);
  const detail = document.createElement('div');
  if (state.clients.length === 0) {
    detail.innerHTML = '<div class="border-2 border-dashed rounded-2xl p-10 text-center text-zinc-600"><p class="mb-4">No clients yet. Add your first one to get moving.</p><button onclick="openAddClientModal()" class="px-4 py-2 rounded-2xl bg-black text-white">Add Client</button></div>';
  } else if (state.activeClientId) {
    const client = state.clients.find(c => c.id === state.activeClientId);
    detail.appendChild(renderClientDetail(client));
  } else {
    detail.innerHTML = '<div class="text-center text-zinc-500">Select a client to view details.</div>';
  }
  container.appendChild(detail);
  return container;
}

// ==== Employees Page ====
// Render a simple employees management page where you can view and add team members.
function renderEmployeesPage() {
  const container = document.createElement('div');
  container.className = 'space-y-6';
  // Header with title and add button
  const header = document.createElement('div');
  header.className = 'flex items-center justify-between';
  header.innerHTML = '<h2 class="text-2xl font-semibold">Employees</h2>' +
    '<button onclick="openAddEmployeeModal()" class="inline-flex items-center gap-2 px-4 py-2 rounded-2xl bg-black text-white hover:opacity-90"><span class="w-4 h-4 inline-block">＋</span> Add Employee</button>';
  container.appendChild(header);
  // List of employees
  const list = document.createElement('div');
  list.className = 'space-y-2';
  if (state.employees && state.employees.length > 0) {
    state.employees.forEach(emp => {
      const row = document.createElement('div');
      row.className = 'flex items-center justify-between p-3 bg-zinc-50 rounded-xl border border-zinc-200';
      row.innerHTML = '<span class="font-medium">' + emp.name + '</span>' +
        '<button onclick="deleteEmployee(\'' + emp.id + '\')" class="text-sm text-red-600 hover:underline">Remove</button>';
      list.appendChild(row);
    });
  } else {
    list.innerHTML = '<div class="text-zinc-500">No employees. Use the button above to add one.</div>';
  }
  container.appendChild(list);
  return container;
}

// Modal to add a new employee. Prompts for a name and adds to state.employees.
function openAddEmployeeModal() {
  openModal('Add Employee', () => {
    const div = document.createElement('div');
    div.innerHTML = '<div class="space-y-4"><div><label class="block text-sm mb-1">Name</label><input id="newEmployeeName" class="w-full px-3 py-2 rounded-xl border border-zinc-300" placeholder="Enter full name" /></div></div>' +
      '<div class="flex justify-end gap-2 mt-4"><button onclick="closeModal()" class="px-4 py-2 rounded-xl bg-zinc-100">Cancel</button><button id="addEmployeeSaveBtn" class="px-4 py-2 rounded-xl bg-black text-white">Add</button></div>';
    setTimeout(() => {
      const input = div.querySelector('#newEmployeeName');
      const saveBtn = div.querySelector('#addEmployeeSaveBtn');
      saveBtn.addEventListener('click', () => {
        const newName = input.value.trim();
        if (!newName) { alert('Name required'); return; }
        const exists = (state.employees || []).some(e => e.id === newName);
        if (exists) { alert('Employee already exists'); return; }
        state.employees = (state.employees || []).concat([{ id: newName, name: newName }]);
        saveState();
        closeModal();
        render();
      });
    }, 0);
    return div;
  });
}

// Open a modal to assign a task to an employee. Lists employees and duplicates the task
// for the selected employee. The duplicated task is appended to state.tasks with a new id
// and an assignee field pointing to the employee id. The original task remains.
function openAssignModal(taskId) {
  const task = (state.tasks || []).find(t => t.id === taskId);
  if (!task) {
    alert('Task not found');
    return;
  }
  openModal('Assign Task', () => {
    const div = document.createElement('div');
    div.className = 'space-y-3';
    // Build buttons for each employee
    (state.employees || []).forEach(emp => {
      const btn = document.createElement('button');
      btn.className = 'w-full text-left px-3 py-2 rounded-lg hover:bg-zinc-100 border border-zinc-200';
      btn.textContent = emp.name;
      btn.addEventListener('click', () => {
        assignTaskToEmployee(taskId, emp.id);
        closeModal();
      });
      div.appendChild(btn);
    });
    // Optionally show a message if there are no employees
    if (!state.employees || state.employees.length === 0) {
      const p = document.createElement('p');
      p.textContent = 'No employees available.';
      div.appendChild(p);
    }
    return div;
  });
}

// Duplicate a task for a specific employee. Creates a new task with a new id and
// sets the assignee property. Adds it to state.tasks and persists state.
function assignTaskToEmployee(taskId, employeeId) {
  const original = (state.tasks || []).find(t => t.id === taskId);
  if (!original) return;
  // Assign the original task to the selected employee rather than duplicating it.
  // This keeps the task on the manager's calendar but only once. The assignee suffix
  // will indicate who the task belongs to.
  original.assignee = employeeId;
  // Remove any lingering duplicate tasks that may have been created by previous builds
  // with the same title, due date, client and phase. We keep only the original task.
  state.tasks = (state.tasks || []).filter(t => {
    if (t.id === original.id) return true;
    const sameTitle = t.title === original.title;
    const sameDue = t.dueDate === original.dueDate;
    const sameClient = t.clientId === original.clientId;
    const samePhase = (t.phase || '') === (original.phase || '');
    const sameStart = (t.startDate || '') === (original.startDate || '');
    // Consider tasks duplicates if they share title, due date, client, phase and start date
    return !(sameTitle && sameDue && sameClient && samePhase && sameStart);
  });
  saveState();
  render();
}

// Remove an employee by id. Does not reassign or delete any tasks; tasks
// assigned to this id will remain but will not match any employee. Use with caution.
function deleteEmployee(empId) {
  if (!confirm('Remove this employee?')) return;
  state.employees = (state.employees || []).filter(e => e.id !== empId);
  saveState();
  render();
}
function setActiveClient(id) {
  state.activeClientId = id;
  saveState();
  render();
}
function toggleClientMenu(id) {
  const menu = document.getElementById('menu-' + id);
  if (menu) {
    menu.classList.toggle('hidden');
  }
}
// Show confirmation modal before deleting a client
function openDeleteClientConfirm(clientId) {
  const client = state.clients.find(c => c.id === clientId);
  if (!client) return;
  openModal('Delete Client', () => {
    const div = document.createElement('div');
    div.className = 'space-y-4';
    div.innerHTML = `<p>Are you sure you want to delete client <strong>${client.name}</strong> and all associated data?</p>
      <div class="flex justify-end gap-2 flex-wrap">
        <button onclick="closeModal()" class="px-3 py-2 rounded-xl bg-zinc-100">Cancel</button>
        <button onclick="deleteClient('${clientId}')" class="px-3 py-2 rounded-xl bg-red-600 hover:bg-red-700 text-white">Delete</button>
      </div>`;
    return div;
  });
}
function deleteClient(id) {
  if (!confirm('Delete this client?')) return;
  state.clients = state.clients.filter(c => c.id !== id);
  state.events = state.events.filter(e => e.clientId !== id);
  delete state.contentData[id];
  delete state.contentArchive[id];
  if (state.activeClientId === id) state.activeClientId = null;
  saveState();
  render();
}

// Apply an array of generated ideas to the specified client's content. This
// helper centralises the logic for populating scripts and captions so it can be
// reused by both the primary and fallback idea-generation paths. It will
// initialise the content object if necessary and then assign each idea into
// the scripts and captions arrays. After updating, it persists state and
// re-renders the UI.
function applyIdeasToContent(clientId, ideas) {
  const client = state.clients.find(c => c.id === clientId);
  if (!client) return;
  const content = state.contentData[client.id] || (state.contentData[client.id] = {});
  content.scripts = content.scripts || [];
  content.captions = content.captions || [];
  ideas.forEach((idea, index) => {
    const outline = Array.isArray(idea.outline) ? idea.outline : [];
    content.scripts[index] = {
      header: idea.title || `Idea ${index + 1}`,
      script: (idea.hook ? idea.hook + '\n\n' : '') + outline.map((s, i) => `${i + 1}. ${s}`).join('\n')
    };
    content.captions[index] = idea.caption || '';
  });
  saveState();
  render();
}

// === Idea Generation ===
// Trigger the generation of video ideas for a given client. This is a stub that can
// later be replaced by a call to a server-side endpoint (e.g. Supabase Edge
// Function) that analyzes the client's social data and returns high-quality
// concepts. For now it simply alerts the user.
// Trigger video idea generation for the given client. This implementation
// calls your Supabase Edge Function (named `super-responder`) via the
// Supabase client. It sends the client object along with any saved
// social handles and a set of goals to the function. When ideas are
// returned, it populates the first slots of the client's scripts and
// captions arrays. Any errors during invocation or parsing are caught
// and surfaced to the user. To support this, the module script assigns
// `supabase` to `window.supabase` so it can be accessed here.
async function generateVideoIdeas(clientId) {
  const client = state.clients.find(c => c.id === clientId);
  if (!client) {
    alert('Client not found');
    return;
  }
  // Gather any saved handles for this client from the analytics state. If none
  // exist, default to an empty object. These are optional but allow the
  // backend to tailor ideas based on platform profiles.
  const handles = (state.analyticsHandles && state.analyticsHandles[clientId]) || {};
  // Define default goals. Adjust these per client or expose controls in the UI
  // if you want the user to specify objectives and tone.
  const goals = { objective: 'grow foot traffic', tone: 'casual, punchy' };
  try {
    // First attempt: use the Supabase JS client to invoke the edge function.
    const { data, error } = await window.supabase.functions.invoke('super-responder', {
      body: { client, handles, goals }
    });
    // Throw if the client returned an explicit error
    if (error) throw new Error(error.message || error);
    let ideas = (data && data.ideas) || [];
    // If no ideas were returned, either the function didn't return data or there
    // was a silent failure. We'll handle this in the fallback below.
    if (!ideas.length) {
      throw new Error('No ideas returned');
    }
    // Persist the returned ideas into the client's content
    applyIdeasToContent(client.id, ideas);
    alert(`Added ${ideas.length} ideas to ${client.name}'s Scripts/Captions.`);
  } catch (err) {
    console.warn('Primary invocation failed:', err);
    // If the error indicates the request could not be sent, attempt a direct
    // fetch to the functions domain. This can occur in local development when
    // the browser cannot reach the edge functions via the invoke API.
    const msg = err && err.message ? err.message : '';
    if (msg.includes('Failed to send') || msg.includes('No ideas returned')) {
      try {
        // Construct the functions domain from the Supabase URL. For example,
        // https://xyz.supabase.co -> https://xyz.functions.supabase.co
        const supUrl = window.SUPABASE_URL;
        const parts = supUrl.replace('https://', '').replace('http://', '').split('.');
        const projectRef = parts[0];
        const protocol = supUrl.startsWith('http://') ? 'http' : 'https';
        const fallbackUrl = `${protocol}://${projectRef}.functions.supabase.co/super-responder`;
        // Call the edge function directly with anon key for auth. The anon key is
        // attached in both the apikey and Authorization headers. This is safe
        // for development but you should restrict public access as needed.
        const res = await fetch(fallbackUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'apikey': window.SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${window.SUPABASE_ANON_KEY}`
          },
          body: JSON.stringify({ client, handles, goals })
        });
        if (!res.ok) {
          throw new Error(`Fallback request failed with status ${res.status}`);
        }
        const fallbackData = await res.json();
        const fallbackIdeas = (fallbackData && fallbackData.ideas) || [];
        if (!fallbackIdeas.length) {
          throw new Error('Fallback request succeeded but returned no ideas');
        }
        applyIdeasToContent(client.id, fallbackIdeas);
        alert(`Added ${fallbackIdeas.length} ideas to ${client.name}'s Scripts/Captions.`);
      } catch (fallbackError) {
        console.error('Fallback invocation failed:', fallbackError);
        alert('Idea generation failed: ' + (fallbackError.message || fallbackError));
      }
    } else {
      console.error(err);
      alert('Idea generation failed: ' + (err.message || err));
    }
  }
}
function openAddClientModal() {
  let name='', onboard=todayISO(), color=DEFAULT_COLORS[Math.floor(Math.random()*DEFAULT_COLORS.length)], packageType='mini';
  openModal('Add Client', () => {
    const div = document.createElement('div');
    // Build options list for package select, including a 'none' option for no base deliverables
    const packageOptions = ['none'].concat(Object.keys(PACKAGES));
    const packageSelectHtml = packageOptions.map(p => {
      const label = p === 'none' ? 'None' : p.charAt(0).toUpperCase()+p.slice(1);
      return '<option value="' + p + '">' + label + '</option>';
    }).join('');
    div.innerHTML = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">' +
      '<div><label class="block text-sm mb-1">Client Name</label><input id="clientName" class="w-full px-3 py-2 rounded-xl border border-zinc-300" placeholder="e.g., Vape District" /></div>' +
      '<div><label class="block text-sm mb-1">Onboarding Date</label><input id="clientOnboard" type="date" value="' + onboard + '" class="w-full px-3 py-2 rounded-xl border border-zinc-300" /></div>' +
      '<div><label class="block text-sm mb-1">Package</label><select id="clientPackage" class="w-full px-3 py-2 rounded-xl border border-zinc-300">' + packageSelectHtml + '</select></div>' +
      '<div><label class="block text-sm mb-1">Color</label><div class="flex items-center gap-2 flex-wrap">' + DEFAULT_COLORS.map(c => '<button type="button" data-color="' + c + '" class="w-8 h-8 rounded-full border-2" style="background:' + c + '"></button>').join('') + '</div></div>' +
      // Add‑on checkboxes row
      '</div><div class="mt-4"><label class="block text-sm mb-1">Add‑ons</label>' +
      '<div class="flex items-center gap-4"><label class="inline-flex items-center"><input type="checkbox" id="clientAddonEmailPhone" class="mr-2" />Email/Phone Campaign</label>' +
      '<label class="inline-flex items-center"><input type="checkbox" id="clientAddonDirectMail" class="mr-2" />Direct Mail Campaign</label></div></div>' +
      '<div class="flex items-center justify-end gap-2 mt-6"><button onclick="closeModal()" class="px-4 py-2 rounded-xl bg-zinc-100">Cancel</button><button id="clientSaveBtn" class="px-4 py-2 rounded-xl bg-black text-white">Save</button></div>';
    // color picker
    div.querySelectorAll('[data-color]').forEach(btn => {
      btn.addEventListener('click', () => {
        color = btn.getAttribute('data-color');
        div.querySelectorAll('[data-color]').forEach(b => b.style.borderColor = 'transparent');
        btn.style.borderColor = 'black';
      });
    });
    div.querySelector('#clientSaveBtn').addEventListener('click', () => {
      name = div.querySelector('#clientName').value.trim();
      onboard = div.querySelector('#clientOnboard').value;
      packageType = div.querySelector('#clientPackage').value;
      const includeEmailPhone = div.querySelector('#clientAddonEmailPhone').checked;
      const includeDirectMail = div.querySelector('#clientAddonDirectMail').checked;
      if (!name) return alert('Name required');
      const id = uid();
      // New clients start with a status of 'None' by default instead of 'Scheduling'
      state.clients.push({ id, name, onboardDate:onboard, packageType, color, status:'None', socials:{}, todos:[], createdAt:Date.now(), includeEmailPhone, includeDirectMail });
      state.activeClientId = id;
      saveState();
      closeModal();
      render();
    });
    return div;
  });
}

// Open a modal to add a task to a specific client. Tasks consist of a title,
// due date, optional time and estimated hours. They are initialised with
// status 'todo'. After saving, tasks are persisted to state and the UI
// re-renders. This allows you to track deliverables separately from
// calendar events.
function openAddTaskModal(clientId) {
  const client = state.clients.find(c => c.id === clientId);
  if (!client) return;
  let title = '';
  let startDate = todayISO();
  let dueDate = todayISO();
  let time = '';
  let estHours = '';
  let phase = 'None';
  openModal('Add Task', () => {
    const div = document.createElement('div');
    div.innerHTML = '<div class="space-y-4">' +
      '<div><label class="block text-sm mb-1">Task Title</label><input id="taskTitle" class="w-full px-3 py-2 rounded-xl border border-zinc-300" placeholder="e.g., Film Script" /></div>' +
      '<div class="grid grid-cols-1 md:grid-cols-3 gap-4">' +
        '<div><label class="block text-sm mb-1">Start Date</label><input id="taskStartDate" type="date" value="' + startDate + '" class="w-full px-3 py-2 rounded-xl border border-zinc-300" /></div>' +
        '<div><label class="block text-sm mb-1">Due Date</label><input id="taskDueDate" type="date" value="' + dueDate + '" class="w-full px-3 py-2 rounded-xl border border-zinc-300" /></div>' +
        '<div><label class="block text-sm mb-1">Time (optional)</label><input id="taskTime" type="time" class="w-full px-3 py-2 rounded-xl border border-zinc-300" /></div>' +
      '</div>' +
      '<div><label class="block text-sm mb-1">Estimate Hours (optional)</label><input id="taskEst" type="number" min="0.25" step="0.25" placeholder="e.g., 2" class="w-full px-3 py-2 rounded-xl border border-zinc-300" /></div>' +
      '<div><label class="block text-sm mb-1">Phase</label><select id="taskPhase" class="w-full px-3 py-2 rounded-xl border border-zinc-300"><option value="None">None</option><option value="Scripting">Scripting</option><option value="Filming">Filming</option></select></div>' +
      '</div>' +
      '<div class="flex items-center justify-end gap-2 mt-6"><button onclick="closeModal()" class="px-4 py-2 rounded-xl bg-zinc-100">Cancel</button><button id="taskSaveBtn" class="px-4 py-2 rounded-xl bg-black text-white">Save</button></div>';
    // Add event listeners after insertion
    setTimeout(() => {
      const titleInput = div.querySelector('#taskTitle');
      const startInput = div.querySelector('#taskStartDate');
      const dueInput = div.querySelector('#taskDueDate');
      const timeInput = div.querySelector('#taskTime');
      const estInput = div.querySelector('#taskEst');
      const phaseInput = div.querySelector('#taskPhase');
      div.querySelector('#taskSaveBtn').addEventListener('click', () => {
        title = titleInput.value.trim();
        startDate = startInput.value;
        dueDate = dueInput.value;
        time = timeInput.value;
        estHours = estInput.value;
        if (!title) { alert('Title required'); return; }
        // Create new task object
        // Ensure a valid start and due date. If start is after due, swap them.
        let sDate = startDate || dueDate;
        let dDate = dueDate || startDate;
        if (sDate && dDate && sDate > dDate) {
          const tmp = sDate;
          sDate = dDate;
          dDate = tmp;
        }
        const newTask = {
          id: uid(),
          clientId: client.id,
          title,
          startDate: sDate || null,
          dueDate: dDate || null,
          time: time || '',
          estimateHours: estHours ? Number(estHours) : null,
          status: 'todo',
          phase: phaseInput.value || 'None',
          // Assign this new task to the current employee by default.
          assignee: state.currentEmployeeId
        };
        state.tasks.push(newTask);
        saveState();
        closeModal();
        render();
      });
    }, 0);
    return div;
  });
}

// Open a modal to edit an existing client. Prefills current values and updates the
// client record upon saving. Allows changing name, onboarding date, package,
// color and add-ons. After saving, state is persisted and the UI re-renders.
function openEditClientModal(clientId) {
  const client = state.clients.find(c => c.id === clientId);
  if (!client) return;
  // Pre-fill values
  let name = client.name;
  let onboard = client.onboardDate || todayISO();
  let color = client.color;
  let packageType = client.packageType || 'none';
  let includeEmailPhone = !!client.includeEmailPhone;
  let includeDirectMail = !!client.includeDirectMail;
  openModal('Edit Client', () => {
    const div = document.createElement('div');
    // Build options list for package select, including 'none'
    const packageOptions = ['none'].concat(Object.keys(PACKAGES));
    const packageSelectHtml = packageOptions.map(p => {
      const label = p === 'none' ? 'None' : p.charAt(0).toUpperCase() + p.slice(1);
      return '<option value="' + p + '"' + (packageType === p ? ' selected' : '') + '>' + label + '</option>';
    }).join('');
    div.innerHTML = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">' +
      '<div><label class="block text-sm mb-1">Client Name</label><input id="clientEditName" class="w-full px-3 py-2 rounded-xl border border-zinc-300" value="' + name + '" /></div>' +
      '<div><label class="block text-sm mb-1">Onboarding Date</label><input id="clientEditOnboard" type="date" value="' + onboard + '" class="w-full px-3 py-2 rounded-xl border border-zinc-300" /></div>' +
      '<div><label class="block text-sm mb-1">Package</label><select id="clientEditPackage" class="w-full px-3 py-2 rounded-xl border border-zinc-300">' + packageSelectHtml + '</select></div>' +
      '<div><label class="block text-sm mb-1">Color</label><div class="flex items-center gap-2 flex-wrap">' + DEFAULT_COLORS.map(c => '<button type="button" data-color="' + c + '" class="w-8 h-8 rounded-full border-2" style="background:' + c + ';' + (color === c ? ' border-color:black;' : '') + '"></button>').join('') + '</div></div>' +
      '</div><div class="mt-4"><label class="block text-sm mb-1">Add‑ons</label>' +
      '<div class="flex items-center gap-4"><label class="inline-flex items-center"><input type="checkbox" id="clientEditAddonEmailPhone" class="mr-2"' + (includeEmailPhone ? ' checked' : '') + ' />Email/Phone Campaign</label>' +
      '<label class="inline-flex items-center"><input type="checkbox" id="clientEditAddonDirectMail" class="mr-2"' + (includeDirectMail ? ' checked' : '') + ' />Direct Mail Campaign</label></div></div>' +
      '<div class="flex items-center justify-end gap-2 mt-6"><button onclick="closeModal()" class="px-4 py-2 rounded-xl bg-zinc-100">Cancel</button><button id="clientEditSaveBtn" class="px-4 py-2 rounded-xl bg-black text-white">Save</button></div>';
    // Color picker interaction
    div.querySelectorAll('[data-color]').forEach(btn => {
      btn.addEventListener('click', () => {
        color = btn.getAttribute('data-color');
        // Reset all borders
        div.querySelectorAll('[data-color]').forEach(b => b.style.borderColor = 'transparent');
        btn.style.borderColor = 'black';
      });
    });
    // Save handler
    div.querySelector('#clientEditSaveBtn').addEventListener('click', () => {
      name = div.querySelector('#clientEditName').value.trim();
      onboard = div.querySelector('#clientEditOnboard').value;
      packageType = div.querySelector('#clientEditPackage').value;
      includeEmailPhone = div.querySelector('#clientEditAddonEmailPhone').checked;
      includeDirectMail = div.querySelector('#clientEditAddonDirectMail').checked;
      if (!name) return alert('Name required');
      // Update client properties
      client.name = name;
      client.onboardDate = onboard;
      client.packageType = packageType;
      client.color = color;
      client.includeEmailPhone = includeEmailPhone;
      client.includeDirectMail = includeDirectMail;
      saveState();
      closeModal();
      render();
    });
    return div;
  });
}
function renderClientDetail(client) {
  const container = document.createElement('div');
  // Overall container for the client detail. We first render a header showing the
  // client's name, colour marker, current status and an Edit button. Then we
  // display the two‑column layout for todos, notes, calendar and content.
  container.className = 'space-y-6';
  // Header row with client name, colour and status, plus Edit button
  const topHeader = document.createElement('div');
  topHeader.className = 'flex items-center justify-between';
  // Determine status label class based on auto‑computed status
  // Map legacy 'Scheduling' status to 'Scripting' for display purposes. Determine badge colour
  let displayStatus = client.status;
  if (displayStatus === 'Scheduling') displayStatus = 'Scripting';
  let statusClass;
  if (displayStatus === 'Filming') {
    statusClass = 'bg-blue-100 text-blue-700';
  } else if (displayStatus === 'Scripting') {
    statusClass = 'bg-red-100 text-red-700';
  } else {
    // None or any unknown
    statusClass = 'bg-gray-200 text-gray-700';
  }
  topHeader.innerHTML =
    '<div class="flex items-center gap-2">' +
      '<span class="inline-block w-3 h-3 rounded-full" style="background:' + client.color + '"></span>' +
      '<h2 class="font-semibold text-xl">' + client.name + '</h2>' +
      '<span class="text-xs px-2 py-0.5 rounded-full ' + statusClass + '">' + displayStatus + '</span>' +
    '</div>' +
    '<button onclick="openEditClientModal(\'' + client.id + '\')" class="px-3 py-2 rounded-xl bg-zinc-100 hover:bg-zinc-200 text-sm">Edit</button>';
  container.appendChild(topHeader);
  // Grid layout wrapper for the detail sections
  const detailGrid = document.createElement('div');
  detailGrid.className = 'grid grid-cols-1 lg:grid-cols-4 gap-6';
  // Left column
  const left = document.createElement('div');
  left.className = 'lg:col-span-1 space-y-4';
  // todos
  const todosSec = document.createElement('section');
  todosSec.className = 'bg-white dark:bg-zinc-900 rounded-2xl p-4 shadow-sm';
  todosSec.innerHTML = '<h3 class="font-semibold mb-3">To do</h3>';
  const todoInputDiv = document.createElement('div');
  todoInputDiv.className = 'flex gap-2 mb-3';
  const todoInput = document.createElement('input');
  todoInput.className = 'flex-1 px-3 py-2 rounded-xl border border-zinc-300';
  todoInput.placeholder = 'Add a note...';
  const todoAddBtn = document.createElement('button');
  todoAddBtn.className = 'px-3 py-2 rounded-xl bg-black text-white';
  todoAddBtn.innerHTML = '＋';
  todoAddBtn.onclick = () => {
    const text = todoInput.value.trim();
    if (!text) return;
    client.todos = client.todos || [];
    client.todos.push({ id: uid(), text });
    todoInput.value = '';
    saveState();
    render();
  };
  todoInputDiv.appendChild(todoInput);
  todoInputDiv.appendChild(todoAddBtn);
  todosSec.appendChild(todoInputDiv);
  const todoList = document.createElement('ul');
  todoList.className = 'space-y-2';
  (client.todos||[]).forEach(t => {
    const li = document.createElement('li');
    li.className = 'flex items-center gap-2';
    li.innerHTML = '<span class="w-1.5 h-1.5 rounded-full" style="background:' + client.color + '"></span>' +
      '<span class="flex-1">' + t.text + '</span>';
    const delBtn = document.createElement('button');
    delBtn.className = 'p-2 rounded hover:bg-red-100 text-red-600';
    delBtn.innerHTML = '✕';
    delBtn.onclick = () => {
      client.todos = client.todos.filter(x => x.id !== t.id);
      saveState();
      render();
    };
    li.appendChild(delBtn);
    todoList.appendChild(li);
  });
  if (!client.todos || client.todos.length === 0) {
    const p = document.createElement('p');
    p.className = 'text-sm text-zinc-500';
    p.textContent = 'No notes yet.';
    todoList.appendChild(p);
  }
  todosSec.appendChild(todoList);
  left.appendChild(todosSec);
  // status
  // Remove automatic status updates; clients retain their selected status.
  const statusSec = document.createElement('section');
  statusSec.className = 'bg-white dark:bg-zinc-900 rounded-2xl p-4 shadow-sm';
  statusSec.innerHTML = '<h3 class="font-semibold mb-3">Status</h3>';
  const statuses = ['None','Scripting','Filming'];
  const seg = document.createElement('div');
  seg.className = 'inline-flex rounded-2xl bg-zinc-100 dark:bg-zinc-800 p-1';
  statuses.forEach(s => {
    const btn = document.createElement('button');
    btn.textContent = s;
    btn.className = 'px-3 py-1.5 rounded-xl text-sm ' + (client.status===s?'bg-white dark:bg-zinc-900 shadow text-zinc-900 dark:text-zinc-100':'text-zinc-600 hover:text-zinc-900');
    btn.onclick = () => { client.status = s; saveState(); render(); };
    seg.appendChild(btn);
  });
  statusSec.appendChild(seg);

  left.appendChild(statusSec);

  // --- Tasks section ---
  // Render a list of tasks associated with this client. Tasks can be added via
  // a modal. Each task shows its title, due date, time and status. Overdue
  // tasks are highlighted with a red badge. Tasks are sorted by urgency so
  // overdue and near-due tasks appear first. Users can mark tasks complete or
  // delete them. To add tasks, we provide a button that opens the task modal.
  const tasksSec = document.createElement('section');
  tasksSec.className = 'bg-white dark:bg-zinc-900 rounded-2xl p-4 shadow-sm';
  tasksSec.innerHTML = '<div class="flex items-center justify-between mb-3"><h3 class="font-semibold">Tasks</h3><button class="px-3 py-1.5 rounded-xl bg-zinc-100 hover:bg-zinc-200 text-sm" onclick="openAddTaskModal(\'' + client.id + '\')">Add Task</button></div>';
  // Filter and sort tasks for this client
  const clientTasks = sortTasksByUrgency((state.tasks || []).filter(t => t.clientId === client.id));
  if (!clientTasks || clientTasks.length === 0) {
    const empty = document.createElement('p');
    empty.className = 'text-sm text-zinc-500';
    empty.textContent = 'No tasks yet.';
    tasksSec.appendChild(empty);
  } else {
    // Bulk operation controls
    const bulkDiv = document.createElement('div');
    bulkDiv.className = 'flex items-center justify-between mb-2';
    const selectAll = document.createElement('input');
    selectAll.type = 'checkbox';
    selectAll.className = 'mr-2';
    selectAll.title = 'Select all tasks';
    selectAll.onchange = (e) => {
      if (e.target.checked) {
        clientTasks.forEach(t => selectedTaskIds.add(t.id));
      } else {
        clientTasks.forEach(t => selectedTaskIds.delete(t.id));
      }
      // re-render just task list portion by forcing a full render
      render();
    };
    const bulkBtn = document.createElement('button');
    bulkBtn.className = 'px-3 py-1.5 rounded-xl bg-zinc-100 hover:bg-zinc-200 text-sm';
    bulkBtn.textContent = 'Mark Selected Done';
    bulkBtn.onclick = () => {
      // Mark selected tasks done for this client
      state.tasks.forEach(t => {
        if (selectedTaskIds.has(t.id) && t.clientId === client.id) {
          t.status = 'done';
        }
      });
      // Clear selection
      clientTasks.forEach(t => selectedTaskIds.delete(t.id));
      saveState();
      render();
    };
    bulkDiv.appendChild(selectAll);
    bulkDiv.appendChild(bulkBtn);
    tasksSec.appendChild(bulkDiv);
    const list = document.createElement('div');
    list.className = 'space-y-2';
    clientTasks.forEach(t => {
      const row = document.createElement('div');
      row.className = 'flex items-start justify-between gap-2 p-2 rounded-lg hover:bg-zinc-50';
      // Checkbox for bulk selection
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.className = 'mt-1 mr-2';
      cb.checked = selectedTaskIds.has(t.id);
      cb.onchange = (e) => {
        if (e.target.checked) {
          selectedTaskIds.add(t.id);
        } else {
          selectedTaskIds.delete(t.id);
        }
      };
      row.appendChild(cb);
      // Left side: title and meta
      const leftCol = document.createElement('div');
      leftCol.className = 'flex flex-col flex-1';
      const titleEl = document.createElement('div');
      titleEl.className = 'font-medium';
      // Show assignment suffix on task titles so it is clear when tasks are delegated
      const suffix = assigneeSuffix(t.assignee);
      titleEl.textContent = (t.title || '(Untitled)') + suffix;
      const meta = document.createElement('div');
      meta.className = 'text-xs text-zinc-500 flex items-center gap-1';
      const dueStr = t.dueDate ? ('Due ' + t.dueDate + (t.time ? (' ' + t.time) : '')) : 'No due date';
      meta.appendChild(document.createTextNode(dueStr));
      if (t.estimateHours) {
        const estSpan = document.createElement('span');
        estSpan.textContent = '• ~' + t.estimateHours + 'h';
        meta.appendChild(estSpan);
      }
      // If overdue and not done, show Late badge
      const dLeft = daysUntil(t.dueDate, t.time);
      if (dLeft !== null && dLeft < 0 && t.status !== 'done') {
        const lateBadge = document.createElement('span');
        lateBadge.className = 'ml-2 inline-block px-2 py-0.5 rounded-full text-xs badge-late';
        lateBadge.textContent = 'Late';
        meta.appendChild(lateBadge);
      }
      leftCol.appendChild(titleEl);
      leftCol.appendChild(meta);
      // Quick edit: clicking anywhere on the left column opens the edit modal (except on input or buttons)
      leftCol.onclick = (e) => {
        // ignore if clicking inside the checkbox or dropdown or button
        if (e.target.closest('select') || e.target.closest('input[type=checkbox]') || e.target.closest('button')) return;
        openEditTaskModal(t.id);
      };
      row.appendChild(leftCol);
      // Right side: status drop-down and delete button
      const rightCol = document.createElement('div');
      rightCol.className = 'flex items-center gap-1';
      // Status selector
      const statusSel = document.createElement('select');
      statusSel.className = 'text-xs border rounded px-2 py-1';
      ['todo','doing','blocked','done'].forEach(s => {
        const opt = document.createElement('option');
        opt.value = s;
        opt.textContent = s;
        if (t.status === s) opt.selected = true;
        statusSel.appendChild(opt);
      });
      statusSel.onchange = (e) => {
        t.status = e.target.value;
        saveState();
        render();
      };
      rightCol.appendChild(statusSel);
      // Delete button
      const delBtn = document.createElement('button');
      delBtn.className = 'p-1 rounded hover:bg-red-100 text-red-600';
      delBtn.innerHTML = '✕';
      delBtn.onclick = () => {
        state.tasks = state.tasks.filter(x => x.id !== t.id);
        // Remove from selection
        selectedTaskIds.delete(t.id);
        saveState();
        render();
      };
      rightCol.appendChild(delBtn);
      row.appendChild(rightCol);
      list.appendChild(row);
    });
    tasksSec.appendChild(list);
  }
  left.appendChild(tasksSec);
  // Append the left column into the detail grid instead of directly on the container
  detailGrid.appendChild(left);
  // Right column
  const right = document.createElement('div');
  right.className = 'lg:col-span-3 space-y-4';
  const calSec = document.createElement('section');
  calSec.className = 'bg-white dark:bg-zinc-900 rounded-2xl p-4 shadow-sm';
  calSec.innerHTML = '<div class="flex items-center justify-between mb-3"><h3 class="font-semibold">Content Calendar</h3></div>';
  // Render client calendar with navigation controls based on month offset
  const offset = state.clientMonthOffsets[client.id] || 0;
  const baseMonth = new Date();
  baseMonth.setDate(1);
  const displayMonth = new Date(baseMonth.getFullYear(), baseMonth.getMonth() + offset, 1);
  calSec.appendChild(renderClientCalendarWithNav(client, displayMonth));
  right.appendChild(calSec);
  // Append the right column into the detail grid
  detailGrid.appendChild(right);
  // Append the detail grid to the container before returning
  container.appendChild(detailGrid);
  return container;
}

// === Archive Page ===
// Display archived tasks and events grouped by client. Archived items are those
// with status 'done'. Provides a simple overview so you can reference past
// work without cluttering active schedules. Users can optionally restore
// archived items via an "Unarchive" button. Restoring will set status
// back to 'todo' for tasks and events.
function renderArchivePage() {
  const container = document.createElement('div');
  container.className = 'space-y-6';
  const header = document.createElement('div');
  header.className = 'flex items-center justify-between';
  header.innerHTML = '<h2 class="text-2xl font-semibold">Archived</h2>';
  container.appendChild(header);
  // Group archived items by client
  const archivedTasks = (state.tasks || []).filter(t => t.status === 'done');
  const archivedEvents = state.events.filter(ev => ev.status === 'done');
  if (archivedTasks.length === 0 && archivedEvents.length === 0) {
    const empty = document.createElement('div');
    empty.className = 'text-zinc-500 text-sm';
    empty.textContent = 'No archived items yet.';
    container.appendChild(empty);
    return container;
  }
  // Build list per client
  state.clients.forEach(client => {
    const clientTasks = archivedTasks.filter(t => t.clientId === client.id);
    const clientEvents = archivedEvents.filter(e => e.clientId === client.id);
    if (clientTasks.length === 0 && clientEvents.length === 0) return;
    const card = document.createElement('div');
    card.className = 'bg-white rounded-2xl p-4 shadow-sm border border-zinc-100';
    card.innerHTML = '<div class="flex items-center gap-2 mb-2"><span class="inline-block w-3 h-3 rounded-full" style="background:' + client.color + '"></span><h3 class="font-semibold">' + client.name + '</h3></div>';
    const list = document.createElement('div');
    list.className = 'space-y-1';
    // tasks
    clientTasks.forEach(t => {
      const phase = t.phase || 'None';
      const badgeClass = phase === 'Scripting' ? 'bg-red-100 text-red-700' : (phase === 'Filming' ? 'bg-blue-100 text-blue-700' : 'bg-gray-200 text-gray-700');
      const row = document.createElement('div');
      row.className = 'text-sm px-2 py-1 rounded-lg border flex items-center gap-2';
      row.style.borderColor = client.color;
      row.innerHTML = '<span class="px-1.5 py-0.5 rounded ' + badgeClass + ' text-xs mr-1">' + (phase === 'None' ? 'N' : phase.charAt(0)) + '</span>' +
        '<span class="flex-1">' + t.title + '</span>' +
        '<span class="text-xs text-zinc-500">' + (t.dueDate ? fmtDate(t.dueDate) : '') + '</span>' +
        '<button onclick="restoreTask(\'' + t.id + '\')" class="p-1 rounded hover:bg-zinc-200 ml-2 text-xs">↩︎</button>';
      list.appendChild(row);
    });
    // events
    clientEvents.forEach(ev => {
      const phase = ev.phase || '';
      const badgeClass = phase === 'Scripting' ? 'bg-red-100 text-red-700' : (phase === 'Filming' ? 'bg-blue-100 text-blue-700' : 'bg-gray-200 text-gray-700');
      const row = document.createElement('div');
      row.className = 'text-sm px-2 py-1 rounded-lg border flex items-center gap-2';
      row.style.borderColor = client.color;
      const rangeText = ev.endDate && ev.endDate !== ev.date ? (fmtDate(ev.date) + ' – ' + fmtDate(ev.endDate)) : fmtDate(ev.date);
      row.innerHTML = '<span class="px-1.5 py-0.5 rounded ' + badgeClass + ' text-xs mr-1">' + (phase ? phase.charAt(0) : 'E') + '</span>' +
        '<span class="flex-1">' + ev.title + '</span>' +
        '<span class="text-xs text-zinc-500">' + rangeText + '</span>' +
        '<button onclick="restoreEvent(\'' + ev.id + '\')" class="p-1 rounded hover:bg-zinc-200 ml-2 text-xs">↩︎</button>';
      list.appendChild(row);
    });
    card.appendChild(list);
    container.appendChild(card);
  });
  return container;
}

// Restore an archived task by setting its status back to 'todo'. Saves state
// and re-renders the app. If the task cannot be found, nothing happens.
function restoreTask(taskId) {
  const idx = (state.tasks || []).findIndex(t => t.id === taskId);
  if (idx === -1) return;
  state.tasks[idx] = Object.assign({}, state.tasks[idx], { status: 'todo' });
  saveState();
  render();
}

// Restore an archived event by setting its status back to 'todo'. Saves
// state and re-renders. If no event matches the id, nothing happens.
function restoreEvent(eventId) {
  const idx = state.events.findIndex(ev => ev.id === eventId);
  if (idx === -1) return;
  state.events[idx] = Object.assign({}, state.events[idx], { status: 'todo' });
  saveState();
  render();
}

// Show a post-completion prompt after marking a task or event done. Gives the user
// the option to simply confirm completion or confirm and immediately add
// another task for the same client. `clientId` determines which client
// will be pre-selected when opening a new task modal. The modal asks the
// user which action to take.
function showPostCompletePrompt(clientId) {
  const client = state.clients.find(c => c.id === clientId);
  const clientName = client ? client.name : 'this client';
  openModal('Task Completed', () => {
    const div = document.createElement('div');
    div.innerHTML = '<p class="mb-4">You marked an item complete for <strong>' + clientName + '</strong>.</p>' +
      '<div class="flex justify-end gap-2"><button id="pcConfirmBtn" class="px-4 py-2 rounded-xl bg-zinc-100">Confirm</button>' +
      '<button id="pcConfirmAddBtn" class="px-4 py-2 rounded-xl bg-black text-white">Confirm &amp; Add New Task</button></div>';
    setTimeout(() => {
      const confirmBtn = div.querySelector('#pcConfirmBtn');
      const addBtn = div.querySelector('#pcConfirmAddBtn');
      confirmBtn.addEventListener('click', () => {
        closeModal();
      });
      addBtn.addEventListener('click', () => {
        closeModal();
        // open a new task modal for this client using today's date as default
        openAddTaskModal(clientId);
      });
    }, 0);
    return div;
  });
}

// Open a confirmation prompt before marking a task or event complete. The prompt
// asks the user to confirm completion and optionally create a new task for
// the same client. The item is only archived once the user confirms. On
// cancellation (closing the modal), the item remains active. `type` should
// be 'task' or 'event', and `id` is the identifier of the item.
function openCompletionPrompt(type, id) {
  let clientId = null;
  let itemTitle = '';
  if (type === 'task') {
    const task = (state.tasks || []).find(t => t.id === id);
    if (!task) return;
    clientId = task.clientId;
    itemTitle = task.title;
  } else if (type === 'event') {
    const ev = state.events.find(e => e.id === id);
    if (!ev) return;
    clientId = ev.clientId;
    itemTitle = ev.title;
  } else {
    return;
  }
  const client = state.clients.find(c => c.id === clientId);
  const clientName = client ? client.name : 'this client';
  // Use openModal to ask for confirmation before completing
  openModal('Complete Item', () => {
    const div = document.createElement('div');
    div.innerHTML = '<p class="mb-4">Mark <strong>' + itemTitle + '</strong> complete for <strong>' + clientName + '</strong>?</p>' +
      '<div class="flex justify-end gap-2"><button id="completeCancelBtn" class="px-4 py-2 rounded-xl bg-zinc-100">Cancel</button>' +
      '<button id="completeConfirmBtn" class="px-4 py-2 rounded-xl bg-black text-white">Confirm</button>' +
      '<button id="completeConfirmAddBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white">Confirm &amp; Add New Task</button></div>';
    setTimeout(() => {
      const cancelBtn = div.querySelector('#completeCancelBtn');
      const confirmBtn = div.querySelector('#completeConfirmBtn');
      const addBtn = div.querySelector('#completeConfirmAddBtn');
      cancelBtn.addEventListener('click', () => {
        closeModal();
      });
      confirmBtn.addEventListener('click', () => {
        // perform completion
        if (type === 'task') completeTask(id);
        else completeEvent(id);
        closeModal();
      });
      addBtn.addEventListener('click', () => {
        // perform completion then open new task modal
        if (type === 'task') completeTask(id);
        else completeEvent(id);
        closeModal();
        if (clientId) {
          openAddTaskModal(clientId);
        }
      });
    }, 0);
    return div;
  });
}
function renderClientCalendar(client, monthDate) {
  const y = monthDate.getFullYear();
  const m = monthDate.getMonth();
  const start = new Date(y,m,1);
  const startDay = start.getDay();
  const daysInMonth = new Date(y,m+1,0).getDate();
  const grid = [];
  for(let i=0;i<startDay;i++) grid.push(null);
  for(let d=1; d<=daysInMonth; d++) grid.push(new Date(y,m,d));
  while(grid.length%7!==0) grid.push(null);
  // Only show visible events for the current employee. Admin (Treyven) sees all events; employees see only their assignments.
  const events = (getVisibleEvents() || []).filter(e=> e.clientId===client.id && e.status !== 'done');
  const eventsByDay = iso => events.filter(e=> e.date===iso).sort((a,b) => {
    if (a.allDay === b.allDay) return (a.time||'').localeCompare(b.time||'');
    return a.allDay ? -1 : 1;
  });
  const container = document.createElement('div');
  const daysRow = document.createElement('div');
  daysRow.className = 'grid grid-cols-7 gap-2 text-xs font-medium text-zinc-500 mb-2';
  ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d => {
    const el = document.createElement('div');
    el.className = 'text-center';
    el.textContent = d;
    daysRow.appendChild(el);
  });
  container.appendChild(daysRow);
  const gridEl = document.createElement('div');
  gridEl.className = 'grid grid-cols-7 gap-2';
  grid.forEach(d => {
    if(!d) {
      const div = document.createElement('div');
      div.className = 'h-28 bg-zinc-100 dark:bg-zinc-800 rounded-xl';
      gridEl.appendChild(div);
      return;
    }
    const iso = d.toISOString().slice(0,10);
    const items = eventsByDay(iso);
    const cell = document.createElement('div');
    cell.setAttribute('data-date', iso);
    const isToday = iso === todayISO();
    // Determine shading for this client's onboarding range (0-14 days)
    let isOnboardRange = false;
    if (client.onboardDate) {
      const start = new Date(client.onboardDate + 'T00:00:00');
      const end = new Date(start.getTime() + 14 * 24 * 60 * 60 * 1000);
      const cd = new Date(iso + 'T00:00:00');
      if (cd >= start && cd <= end) {
        isOnboardRange = true;
      }
    }
    cell.className = 'h-28 rounded-xl border ' + (isToday?'border-black':'border-zinc-200 dark:border-zinc-800') + ' bg-white dark:bg-zinc-900 p-2 flex flex-col';
    if (isOnboardRange) {
      cell.classList.add('shade-onboard');
    }
    const top = document.createElement('div');
    top.className = 'flex items-center justify-between mb-1';
    const addBtn = document.createElement('button');
    addBtn.className = 'text-xs px-2 py-0.5 rounded-lg bg-zinc-100 hover:bg-zinc-200 text-blue-700 font-semibold';
    addBtn.textContent = 'Add';
    addBtn.onclick = () => openEventModal(client.id, iso);
    top.appendChild(addBtn);
    const dateEl = document.createElement('div');
    dateEl.className = 'text-xs text-zinc-500';
    dateEl.textContent = d.getDate();
    top.appendChild(dateEl);
    cell.appendChild(top);
    const list = document.createElement('div');
    list.className = 'space-y-1 overflow-auto pr-1';
    items.forEach(ev => {
      const row = document.createElement('div');
      row.className = 'w-full text-left text-xs px-2 py-1 rounded-lg border flex items-center gap-2 cursor-pointer';
      row.style.borderColor = client.color;
      // badge
      const phase = ev.phase || '';
      const badgeSpan = document.createElement('span');
      badgeSpan.className = 'px-1.5 py-0.5 rounded ' + (phase==='Scripting' ? 'bg-red-100 text-red-700' : (phase==='Filming' ? 'bg-blue-100 text-blue-700' : 'bg-gray-200 text-gray-700'));
      badgeSpan.textContent = phase ? phase.charAt(0) : 'E';
      row.appendChild(badgeSpan);
      // title with assignee suffix so the manager can see who owns each event
      const titleSpan = document.createElement('span');
      titleSpan.className = 'font-medium flex-1 text-zinc-900';
      titleSpan.textContent = ev.title + assigneeSuffix(ev.assignee);
      row.appendChild(titleSpan);
      // optional time indicator
      if (!ev.allDay && ev.time) {
        const timeSpan = document.createElement('span');
        timeSpan.className = 'ml-2 inline-flex items-center gap-1 text-zinc-500';
        timeSpan.textContent = '⏰' + ev.time;
        row.appendChild(timeSpan);
      }
      // controls
      const controls = document.createElement('div');
      controls.className = 'flex items-center gap-1 ml-auto';
      const chk = document.createElement('button');
      chk.className = 'p-1 rounded hover:bg-zinc-200';
      chk.textContent = '✔';
      chk.addEventListener('click', (e) => {
        e.stopPropagation();
        completeEvent(ev.id);
      });
      const menu = document.createElement('button');
      menu.className = 'p-1 rounded hover:bg-zinc-200';
      menu.textContent = '⋯';
      menu.addEventListener('click', (e) => {
        e.stopPropagation();
        // Pass the click event so the menu can be positioned correctly
        openEventOptions(ev.id, e);
      });
      controls.appendChild(chk);
      controls.appendChild(menu);
      row.appendChild(controls);
      // clicking anywhere else will highlight the event range
      row.addEventListener('click', () => {
        highlightCalendarRange(ev.date, ev.endDate || ev.date);
      });
      // Enable dragging of events within client calendar. Set dataTransfer with type and id
      row.setAttribute('draggable', 'true');
      row.addEventListener('dragstart', e => {
        try { e.dataTransfer.setData('application/json', JSON.stringify({ type:'event', id: ev.id })); }
        catch(err) {}
      });
      list.appendChild(row);
    });
    // Render tasks that span this day for this client. Use getVisibleTasks() so employees see only their assignments.
    const dayTasks = (getVisibleTasks() || []).filter(t => {
      if (t.clientId !== client.id || t.status === 'done') return false;
      const s = t.startDate || t.dueDate;
      const e = t.dueDate || t.startDate;
      if (!s || !e) return false;
      return s <= iso && e >= iso;
    });
    dayTasks.forEach(t => {
      const row = document.createElement('div');
      row.className = 'w-full text-left text-xs px-2 py-1 rounded-lg border flex items-center gap-2 cursor-pointer';
      row.style.borderColor = client.color;
      const phase = t.phase || 'None';
      const badgeSpan = document.createElement('span');
      badgeSpan.className = 'px-1.5 py-0.5 rounded ' + (phase === 'Scripting' ? 'bg-red-100 text-red-700' : (phase === 'Filming' ? 'bg-blue-100 text-blue-700' : 'bg-gray-200 text-gray-700'));
      badgeSpan.textContent = (phase === 'None' ? 'N' : phase.charAt(0));
      row.appendChild(badgeSpan);
      const titleSpan = document.createElement('span');
      titleSpan.className = 'font-medium flex-1 text-zinc-900';
      // Append assignee suffix to clearly indicate who owns this task
      titleSpan.textContent = t.title + assigneeSuffix(t.assignee);
      row.appendChild(titleSpan);
      if (t.time) {
        const timeSpan = document.createElement('span');
        timeSpan.className = 'ml-2 inline-flex items-center gap-1 text-zinc-500';
        timeSpan.textContent = '⏰' + t.time;
        row.appendChild(timeSpan);
      }
      const controls = document.createElement('div');
      controls.className = 'flex items-center gap-1 ml-auto';
      const chk = document.createElement('button');
      chk.className = 'p-1 rounded hover:bg-zinc-200';
      chk.textContent = '✔';
      chk.addEventListener('click', (e) => {
        e.stopPropagation();
        openCompletionPrompt('task', t.id);
      });
      const menu = document.createElement('button');
      menu.className = 'p-1 rounded hover:bg-zinc-200';
      menu.textContent = '⋯';
      menu.addEventListener('click', (e) => {
        e.stopPropagation();
        // Pass the click event to openTaskOptions so it can position the menu properly
        openTaskOptions(t.id, e);
      });
      controls.appendChild(chk);
      controls.appendChild(menu);
      row.appendChild(controls);
      row.addEventListener('click', (e) => {
        const startIso = t.startDate || t.dueDate;
        const endIso = t.dueDate || t.startDate;
        highlightCalendarRange(startIso, endIso);
        openTaskPopover(t.id, row);
        e.stopPropagation();
      });
      // Enable dragging of tasks within client calendar. Use dataTransfer to store type and id
      row.setAttribute('draggable', 'true');
      row.addEventListener('dragstart', e => {
        try { e.dataTransfer.setData('application/json', JSON.stringify({ type:'task', id: t.id })); }
        catch(err) {}
      });
      list.appendChild(row);
    });
    cell.appendChild(list);
    // Allow dropping tasks or events onto this date. This enables drag‑and‑drop
    // functionality in the client calendar similar to the overview month view.
    cell.addEventListener('dragover', e => {
      e.preventDefault();
    });
    cell.addEventListener('drop', e => {
      e.preventDefault();
      const data = e.dataTransfer.getData('application/json');
      if (!data) return;
      let obj;
      try { obj = JSON.parse(data); } catch(err) { return; }
      const targetIso = cell.getAttribute('data-date');
      if (!targetIso) return;
      if (obj.type === 'task') {
        moveTask(obj.id, targetIso);
      } else if (obj.type === 'event') {
        moveEvent(obj.id, targetIso);
      }
      saveState();
      render();
    });
    gridEl.appendChild(cell);
  });
  container.appendChild(gridEl);
  return container;
}
// Event modals (openEventModal and openEditEventModal) defined earlier, reused

// ==== Schedule Page ====
function renderSchedulePage() {
  const container = document.createElement('div');
  container.className = 'space-y-4';
  const rangeOptions = [ { label:'Week', days:7 }, { label:'Bi-weekly', days:14 }, { label:'Monthly', days:30 }, { label:'3 months', days:90 }, { label:'6 months', days:180 }, { label:'All', days:null } ];
  let currentRange = state.rangeDays;
  const header = document.createElement('div');
  header.className = 'flex items-center justify-between';
  header.innerHTML = '<h2 class="text-2xl font-semibold">Schedule</h2>';
  const btns = document.createElement('div');
  btns.className = 'flex gap-2';
  rangeOptions.forEach(o => {
    const b = document.createElement('button');
    b.className = 'px-3 py-2 rounded-xl text-sm ' + (currentRange===o.days?'bg-black text-white':'bg-zinc-100 hover:bg-zinc-200');
    b.textContent = o.label;
    b.onclick = () => {
      currentRange = o.days;
      state.rangeDays = o.days;
      // update the display of buttons and list, and refresh overview
      renderScheduleList();
      render();
    };
    btns.appendChild(b);
  });
  header.appendChild(btns);
  container.appendChild(header);
  const listSec = document.createElement('div');
  listSec.className = 'bg-white rounded-2xl p-4 shadow-sm';
  container.appendChild(listSec);
  function renderScheduleList() {
    listSec.innerHTML = '';
    const now = new Date();
    const end = currentRange ? new Date(now.getTime() + currentRange*24*60*60*1000) : null;
    // Use only visible events when building the schedule list. This ensures that
    // employees see only their assignments while the manager sees all events.
    const list = getVisibleEvents().filter(e => {
      const d = new Date(e.date + 'T00:00:00');
      return !currentRange || (d >= new Date(now.toDateString()) && d <= end);
    }).sort((a,b) => a.date.localeCompare(b.date) || (a.time||'').localeCompare(b.time||''));
    // Collapse events across the range so repeated multi‑day tasks appear once
    const grouped = collapseEvents(list);
    if (grouped.length === 0) {
      listSec.innerHTML = '<p class="text-zinc-500">No items in this range.</p>';
      return;
    }
    const ul = document.createElement('ul');
    ul.className = 'divide-y divide-zinc-200 dark:divide-zinc-800';
    grouped.forEach(ev => {
      const client = state.clients.find(c => c.id === ev.clientId) || { name:'Unknown', color:'#999' };
      const li = document.createElement('li');
      li.className = 'py-3 flex items-center gap-3';
      li.innerHTML = '<span class="inline-block w-2.5 h-2.5 rounded-full" style="background:' + client.color + '"></span>' +
        '<div class="flex-1"><div class="font-medium">' + client.name + ' • ' + ev.title + '</div><div class="text-sm text-zinc-500">' + fmtDate(ev.date) + (ev.endDate && ev.endDate!==ev.date ? ' — ' + fmtDate(ev.endDate) : '') + ' ' + (ev.allDay?'(All day)': ev.time? '• ' + ev.time : '') + ' • ' + ev.type + '</div></div>' +
        '<span class="text-xs px-2 py-0.5 rounded-full ' + (ev.phase==='Scripting'?'bg-red-100 text-red-700':'bg-blue-100 text-blue-700') + '">' + ev.phase + '</span>' +
        '<button onclick="openDeleteEventConfirm(\'' + ev.id + '\')" class="ml-2 p-1 rounded hover:bg-zinc-200">🗑</button>';
        // Clicking anywhere on the event row (except action buttons) opens the options menu
        // Capture the event id from the outer scope since the inner callback's parameter
        // refers to the click event object. Use a named variable to avoid shadowing.
        const eventIdToOpen = ev.id;
        li.addEventListener('click', (clickEvent) => {
          if (clickEvent.target.closest('button')) return;
          openEventOptions(eventIdToOpen);
        });
        ul.appendChild(li);
    });
    listSec.appendChild(ul);
  }
  renderScheduleList();
  return container;
}
// ==== Content Page ====
function renderContentPage() {
  const container = document.createElement('div');
  if (!state.clients.length) {
    container.innerHTML = '<p class="text-center text-zinc-500">No clients yet. Add clients to plan content.</p>';
    return container;
  }
  if (!state.contentClientId) {
    container.innerHTML = '<h2 class="text-2xl font-semibold mb-4">Content</h2>';
    const grid = document.createElement('div');
    grid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4';
    state.clients.forEach(c => {
      const card = document.createElement('div');
      card.className = 'bg-white rounded-2xl p-4 shadow cursor-pointer hover:shadow-lg transition';
      card.onclick = () => { state.contentClientId = c.id; render(); };
      const pkg = PACKAGES[c.packageType] || PACKAGES.mini;
      // Build a deliverables summary based on selected package and add‑ons
      let deliverablesList = [];
      if (c.packageType && c.packageType !== 'none') {
        // If a base package is selected, include videos, carousels and photos
        deliverablesList.push('Videos','Carousels','Photos');
      }
      if (c.includeEmailPhone) deliverablesList.push('Email/Phone Campaign');
      if (c.includeDirectMail) deliverablesList.push('Direct Mail');
      const deliverablesText = deliverablesList.length > 0 ? deliverablesList.join(', ') : 'None';
      card.innerHTML = '<div class="flex items-center gap-3 mb-4">' +
        (c.logo_url ? '<img src="' + c.logo_url + '" class="h-8 w-8 rounded-full"/>' : '<div class="h-8 w-8 rounded-full" style="background:' + c.color + '"></div>') +
        '<div class="flex-1"><h3 class="text-lg font-semibold">' + c.name + '</h3><p class="text-xs text-zinc-500">Package: ' + (c.packageType === 'none' ? 'None' : c.packageType.charAt(0).toUpperCase()+c.packageType.slice(1)) + '</p></div>' +
        '</div>' +
        '<div class="text-sm text-zinc-500"><p>Deliverables: ' + deliverablesText + '</p></div>';
      grid.appendChild(card);
    });
    container.appendChild(grid);
  } else {
    const client = state.clients.find(c => c.id === state.contentClientId);
    if (!client) {
      state.contentClientId = null;
      render();
      return container;
    }
    // Build a package definition based on the client's package and add‑ons. If no package
    // (packageType 'none') is selected, videos/carousels/photos are zero. Email/phone
    // campaigns default to the video count or 4 if no videos. Direct mail defaults to 2.
    let basePkg;
    if (client.packageType && client.packageType !== 'none') {
      basePkg = PACKAGES[client.packageType] || { videos:0, carousels:0, photos:0, emails:0, phones:0, directMail:0 };
    } else {
      basePkg = { videos:0, carousels:0, photos:0, emails:0, phones:0, directMail:0 };
    }
    const pkg = {
      videos: basePkg.videos || 0,
      carousels: basePkg.carousels || 0,
      photos: basePkg.photos || 0,
      emails: client.includeEmailPhone ? (basePkg.videos || 4) : 0,
      phones: client.includeEmailPhone ? (basePkg.videos || 4) : 0,
      directMail: client.includeDirectMail ? (basePkg.directMail || 2) : 0
    };
    // ensure content exists with appropriate array lengths
    const base = {
      scripts: Array(pkg.videos).fill({ header:'', script:'' }),
      videos: Array(pkg.videos).fill(null),
      carousels: Array(pkg.carousels).fill([]),
      photos: Array(pkg.photos).fill(null),
      captions: Array(pkg.videos).fill(''),
      carouselCaptions: Array(pkg.carousels).fill(''),
      photoCaptions: Array(pkg.photos).fill(''),
      emails: Array(pkg.emails).fill(null),
      phones: Array(pkg.phones).fill(''),
      directMail: Array(pkg.directMail).fill(null),
      influencer: false,
      campaigns: 2,
      updatedAt: null
    };
    const content = state.contentData[client.id] = state.contentData[client.id] || JSON.parse(JSON.stringify(base));
    // Ensure caption arrays for carousels/photos exist with appropriate lengths
    if (!content.carouselCaptions) content.carouselCaptions = Array(pkg.carousels).fill('');
    if (!content.photoCaptions) content.photoCaptions = Array(pkg.photos).fill('');
    // Update package counts based on current content lengths so dynamic add/remove reflects in UI
    pkg.videos = content.scripts.length;
    pkg.carousels = content.carousels.length;
    pkg.photos = content.photos.length;
    pkg.emails = content.emails.length;
    pkg.phones = content.phones.length;
    pkg.directMail = content.directMail.length;
    container.innerHTML = '<div class="mb-4 flex items-center justify-between"><div class="flex items-center gap-3"><button onclick="exitContentClient()" class="px-3 py-2 rounded-xl bg-zinc-100 dark:bg-zinc-800 mr-2">← Back</button><h2 class="text-2xl font-semibold">' + client.name + ' – Content Plan</h2></div><button onclick="resetClientContent(\'' + client.id + '\')" class="px-3 py-2 rounded-xl bg-red-600 hover:bg-red-700 text-white">Archive & Reset</button></div>';
    // Influencer & campaigns controls
    const controls = document.createElement('div');
    controls.className = 'grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6';
    controls.innerHTML = '<div class="bg-white rounded-2xl p-4 shadow-sm"><label class="inline-flex items-center gap-2"><input type="checkbox" id="influencerToggle" ' + (content.influencer?'checked':'') + ' />Influencer video this month</label></div>' +
      '<div class="bg-white rounded-2xl p-4 shadow-sm"><label class="block text-sm mb-1">Email & Phone campaigns / month</label><input id="campaignsInput" type="number" min="2" max="4" value="' + content.campaigns + '" class="w-full px-3 py-2 rounded-xl border border-zinc-300" /></div>';
    container.appendChild(controls);
    // Videos section: header with controls and cards for scripts/videos/captions
    (function(){
      // Section wrapper
      const section = document.createElement('div');
      section.className = 'mb-8';
      // Header row with title and actions
      const headerRow = document.createElement('div');
      headerRow.className = 'flex items-center justify-between mb-3';
      headerRow.innerHTML = '<h3 class="font-semibold text-lg">Videos</h3>' +
        '<div class="flex items-center gap-2">' +
        // Idea generation button appears to the left of the plus/minus controls. It triggers
        // a stub that will eventually call your backend to analyze past posts and
        // produce high‑quality concepts for this client. The styling differentiates it
        // from other actions.
        '<button onclick="generateVideoIdeas(\'' + client.id + '\')" class="px-2 py-1 rounded-lg bg-yellow-100 text-yellow-800 text-xs">Generate Ideas</button>' +
        '<button onclick="adjustContentSlots(\'' + client.id + '\', \'videos\', 1)" class="w-8 h-8 flex items-center justify-center rounded-full border border-green-500 text-green-500 hover:bg-green-50">+</button>' +
        '<button onclick="adjustContentSlots(\'' + client.id + '\', \'videos\', -1)" class="w-8 h-8 flex items-center justify-center rounded-full border border-red-500 text-red-500 hover:bg-red-50">−</button>' +
        '</div>';
      section.appendChild(headerRow);
      // Grid of video cards
      const videoGrid = document.createElement('div');
      videoGrid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4';
      for (let i = 0; i < pkg.videos; i++) {
        const sec = document.createElement('div');
        sec.className = 'bg-white rounded-2xl border border-zinc-300 p-4 shadow-sm hover:shadow-md transition-shadow space-y-3';
        let inner = '';
        inner += '<h4 class="font-semibold">' + client.name + ' Video #' + (i + 1) + '</h4>';
        inner += '<div><label class="block text-sm mb-1">Header</label><input type="text" class="w-full px-3 py-2 rounded-xl border border-zinc-300" placeholder="Header" value="' + (content.scripts[i]?.header || '') + '" id="scriptHeader-' + i + '" /></div>';
        inner += '<div><label class="block text-sm mb-1">Script</label><textarea class="w-full h-24 px-3 py-2 rounded-xl border border-zinc-300" placeholder="Script" id="scriptBody-' + i + '">' + (content.scripts[i]?.script || '') + '</textarea></div>';
        inner += '<div><label class="block text-sm mb-1">Video upload</label><input type="file" accept="video/*" class="w-full" id="videoUpload-' + i + '" /></div>';
        inner += '<div class="text-xs text-zinc-500">' + (content.videos[i] ? 'Video uploaded.' : 'No video uploaded.') + '</div>';
        inner += '<div><label class="block text-sm mb-1">Caption</label><textarea class="w-full h-20 px-3 py-2 rounded-xl border border-zinc-300" placeholder="Caption" id="caption-' + i + '">' + (content.captions[i] || '') + '</textarea></div>';
        sec.innerHTML = inner;
        videoGrid.appendChild(sec);
      }
      section.appendChild(videoGrid);
      container.appendChild(section);
    })();
    // Carousels section
    (function(){
      const section = document.createElement('div');
      section.className = 'mb-8';
      const headerRow = document.createElement('div');
      headerRow.className = 'flex items-center justify-between mb-3';
      headerRow.innerHTML = '<h3 class="font-semibold text-lg">Carousels</h3>' +
        '<div class="flex gap-2">' +
        '<button onclick="adjustContentSlots(\'' + client.id + '\', \'carousels\', 1)" class="w-8 h-8 flex items-center justify-center rounded-full border border-green-500 text-green-500 hover:bg-green-50">+</button>' +
        '<button onclick="adjustContentSlots(\'' + client.id + '\', \'carousels\', -1)" class="w-8 h-8 flex items-center justify-center rounded-full border border-red-500 text-red-500 hover:bg-red-50">−</button>' +
        '</div>';
      section.appendChild(headerRow);
      const carouselGrid = document.createElement('div');
      carouselGrid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4';
      for (let i = 0; i < pkg.carousels; i++) {
        const card = document.createElement('div');
        card.className = 'bg-white rounded-2xl border border-zinc-300 p-4 shadow-sm hover:shadow-md transition-shadow';
        card.innerHTML = '<h4 class="font-semibold mb-2">' + client.name + ' Carousel #' + (i + 1) + '</h4>' +
          '<input type="file" accept="image/*" multiple class="w-full" id="carouselUpload-' + i + '" />' +
          '<div class="text-xs text-zinc-500 mt-1">' + ((content.carousels[i] && content.carousels[i].length) ? content.carousels[i].length + ' images uploaded.' : 'No images uploaded.') + '</div>' +
          '<div><label class="block text-sm mb-1 mt-2">Caption</label><textarea class="w-full h-16 px-3 py-2 rounded-xl border border-zinc-300" placeholder="Caption" id="carouselCaption-' + i + '">' + (content.carouselCaptions && content.carouselCaptions[i] ? content.carouselCaptions[i] : '') + '</textarea></div>';
        carouselGrid.appendChild(card);
      }
      section.appendChild(carouselGrid);
      container.appendChild(section);
    })();
    // Photos section
    (function(){
      const section = document.createElement('div');
      section.className = 'mb-8';
      const headerRow = document.createElement('div');
      headerRow.className = 'flex items-center justify-between mb-3';
      headerRow.innerHTML = '<h3 class="font-semibold text-lg">Photos</h3>' +
        '<div class="flex gap-2">' +
        '<button onclick="adjustContentSlots(\'' + client.id + '\', \'photos\', 1)" class="w-8 h-8 flex items-center justify-center rounded-full border border-green-500 text-green-500 hover:bg-green-50">+</button>' +
        '<button onclick="adjustContentSlots(\'' + client.id + '\', \'photos\', -1)" class="w-8 h-8 flex items-center justify-center rounded-full border border-red-500 text-red-500 hover:bg-red-50">−</button>' +
        '</div>';
      section.appendChild(headerRow);
      const photoGrid = document.createElement('div');
      photoGrid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4';
      for (let i = 0; i < pkg.photos; i++) {
        const card = document.createElement('div');
        card.className = 'bg-white rounded-2xl border border-zinc-300 p-4 shadow-sm hover:shadow-md transition-shadow';
        card.innerHTML = '<h4 class="font-semibold mb-2">' + client.name + ' Photo #' + (i + 1) + '</h4>' +
          '<input type="file" accept="image/*" class="w-full" id="photoUpload-' + i + '" />' +
          '<div class="text-xs text-zinc-500 mt-1">' + (content.photos[i] ? 'Photo uploaded.' : 'No photo uploaded.') + '</div>' +
          '<div><label class="block text-sm mb-1 mt-2">Caption</label><textarea class="w-full h-16 px-3 py-2 rounded-xl border border-zinc-300" placeholder="Caption" id="photoCaption-' + i + '">' + (content.photoCaptions && content.photoCaptions[i] ? content.photoCaptions[i] : '') + '</textarea></div>';
        photoGrid.appendChild(card);
      }
      section.appendChild(photoGrid);
      container.appendChild(section);
    })();

    // Email Campaigns section
    (function(){
      const section = document.createElement('div');
      section.className = 'mb-8';
      const headerRow = document.createElement('div');
      headerRow.className = 'flex items-center justify-between mb-3';
      headerRow.innerHTML = '<h3 class="font-semibold text-lg">Email Campaigns</h3>' +
        '<div class="flex gap-2">' +
        '<button onclick="adjustContentSlots(\'' + client.id + '\', \'emails\', 1)" class="w-8 h-8 flex items-center justify-center rounded-full border border-green-500 text-green-500 hover:bg-green-50">+</button>' +
        '<button onclick="adjustContentSlots(\'' + client.id + '\', \'emails\', -1)" class="w-8 h-8 flex items-center justify-center rounded-full border border-red-500 text-red-500 hover:bg-red-50">−</button>' +
        '</div>';
      section.appendChild(headerRow);
      const emailGrid = document.createElement('div');
      emailGrid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4';
      for (let i = 0; i < pkg.emails; i++) {
        const card = document.createElement('div');
        card.className = 'bg-white rounded-2xl border border-zinc-300 p-4 shadow-sm hover:shadow-md transition-shadow';
        card.innerHTML = '<h4 class="font-semibold mb-2">' + client.name + ' Email Campaign #' + (i + 1) + '</h4>' +
          '<input type="file" accept=".pdf,.doc,.docx,.txt,image/*" class="w-full" id="emailUpload-' + i + '" />' +
          '<div class="text-xs text-zinc-500 mt-1">' + (content.emails[i] ? 'Document uploaded.' : 'No document uploaded.') + '</div>';
        emailGrid.appendChild(card);
      }
      section.appendChild(emailGrid);
      container.appendChild(section);
    })();

    // Phone Campaigns section
    (function(){
      const section = document.createElement('div');
      section.className = 'mb-8';
      const headerRow = document.createElement('div');
      headerRow.className = 'flex items-center justify-between mb-3';
      headerRow.innerHTML = '<h3 class="font-semibold text-lg">Phone Campaigns</h3>' +
        '<div class="flex gap-2">' +
        '<button onclick="adjustContentSlots(\'' + client.id + '\', \'phones\', 1)" class="w-8 h-8 flex items-center justify-center rounded-full border border-green-500 text-green-500 hover:bg-green-50">+</button>' +
        '<button onclick="adjustContentSlots(\'' + client.id + '\', \'phones\', -1)" class="w-8 h-8 flex items-center justify-center rounded-full border border-red-500 text-red-500 hover:bg-red-50">−</button>' +
        '</div>';
      section.appendChild(headerRow);
      const phoneGrid = document.createElement('div');
      phoneGrid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4';
      for (let i = 0; i < pkg.phones; i++) {
        const card = document.createElement('div');
        card.className = 'bg-white rounded-2xl border border-zinc-300 p-4 shadow-sm hover:shadow-md transition-shadow';
        card.innerHTML = '<h4 class="font-semibold mb-2">' + client.name + ' Phone Campaign #' + (i + 1) + '</h4>' +
          '<textarea class="w-full h-20 px-3 py-2 rounded-xl border border-zinc-300" placeholder="Phone campaign text" id="phoneText-' + i + '">' + (content.phones[i] || '') + '</textarea>';
        phoneGrid.appendChild(card);
      }
      section.appendChild(phoneGrid);
      container.appendChild(section);
    })();

    // Direct Mail section
    (function(){
      const section = document.createElement('div');
      section.className = 'mb-8';
      const headerRow = document.createElement('div');
      headerRow.className = 'flex items-center justify-between mb-3';
      headerRow.innerHTML = '<h3 class="font-semibold text-lg">Direct Mail</h3>' +
        '<div class="flex gap-2">' +
        '<button onclick="adjustContentSlots(\'' + client.id + '\', \'directMail\', 1)" class="w-8 h-8 flex items-center justify-center rounded-full border border-green-500 text-green-500 hover:bg-green-50">+</button>' +
        '<button onclick="adjustContentSlots(\'' + client.id + '\', \'directMail\', -1)" class="w-8 h-8 flex items-center justify-center rounded-full border border-red-500 text-red-500 hover:bg-red-50">−</button>' +
        '</div>';
      section.appendChild(headerRow);
      const directGrid = document.createElement('div');
      directGrid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4';
      for (let i = 0; i < pkg.directMail; i++) {
        const card = document.createElement('div');
        card.className = 'bg-white rounded-2xl border border-zinc-300 p-4 shadow-sm hover:shadow-md transition-shadow';
        card.innerHTML = '<h4 class="font-semibold mb-2">' + client.name + ' Direct Mail #' + (i + 1) + '</h4>' +
          '<input type="file" accept=".pdf,.doc,.docx,.txt,image/*" class="w-full" id="directMailUpload-' + i + '" />' +
          '<div class="text-xs text-zinc-500 mt-1">' + (content.directMail[i] ? 'Content uploaded.' : 'No content uploaded.') + '</div>';
        directGrid.appendChild(card);
      }
      section.appendChild(directGrid);
      container.appendChild(section);
    })();

    // Save button
    const saveBtn = document.createElement('button');
    saveBtn.className = 'px-4 py-2 rounded-xl bg-black text-white';
    saveBtn.textContent = 'Save Content';
    saveBtn.onclick = () => saveContent(client.id, pkg);
    container.appendChild(saveBtn);
  }
  return container;
}

// ==== Analytics Page ====
// This page allows selecting a client to view or configure social media analytics.
function renderAnalyticsPage() {
  const container = document.createElement('div');
  container.className = 'space-y-6';
  // If no client selected, show list of clients
  if (!state.analyticsClientId) {
    const header = document.createElement('div');
    header.className = 'flex items-center justify-between';
    header.innerHTML = '<h2 class="text-2xl font-semibold">Analytics Overview</h2>';
    container.appendChild(header);
    // Compute aggregated metrics across all tasks and events
    const totalTasks = state.tasks.length;
    const completedTasks = state.tasks.filter(t => t.status === 'done').length;
    const tasksByStatus = {};
    state.tasks.forEach(t => {
      tasksByStatus[t.status] = (tasksByStatus[t.status] || 0) + 1;
    });
    // Count tasks by employee (assignee)
    const tasksByEmployee = {};
    (state.tasks || []).forEach(t => {
      const assignee = t.assignee || 'Unassigned';
      tasksByEmployee[assignee] = (tasksByEmployee[assignee] || 0) + 1;
    });
    const totalEvents = state.events.length;
    const completedEvents = state.events.filter(ev => ev.status === 'done').length;
    // Create a summary grid
    const summary = document.createElement('div');
    summary.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8';
    // Total tasks card
    const card1 = document.createElement('div');
    card1.className = 'bg-white rounded-2xl p-4 shadow-sm';
    card1.innerHTML = '<h3 class="font-semibold mb-2">Tasks</h3><p class="text-3xl font-bold">' + totalTasks + '</p><p class="text-sm text-zinc-500 mt-1">Completed: ' + completedTasks + '</p>';
    summary.appendChild(card1);
    // Total events card
    const card2 = document.createElement('div');
    card2.className = 'bg-white rounded-2xl p-4 shadow-sm';
    card2.innerHTML = '<h3 class="font-semibold mb-2">Events</h3><p class="text-3xl font-bold">' + totalEvents + '</p><p class="text-sm text-zinc-500 mt-1">Completed: ' + completedEvents + '</p>';
    summary.appendChild(card2);
    // Tasks by status card
    const card3 = document.createElement('div');
    card3.className = 'bg-white rounded-2xl p-4 shadow-sm';
    let statusHtml = '';
    Object.entries(tasksByStatus).forEach(([status,count]) => {
      statusHtml += '<div class="flex justify-between text-sm mb-1"><span>' + status + '</span><span>' + count + '</span></div>';
    });
    card3.innerHTML = '<h3 class="font-semibold mb-2">Tasks by Status</h3>' + statusHtml;
    summary.appendChild(card3);
    // Tasks by employee card
    const card4 = document.createElement('div');
    card4.className = 'bg-white rounded-2xl p-4 shadow-sm';
    let empHtml = '';
    Object.entries(tasksByEmployee).forEach(([emp,count]) => {
      // Display the employee name (not id) if available
      const empObj = (state.employees || []).find(e => e.id === emp);
      const name = empObj ? empObj.name : emp;
      empHtml += '<div class="flex justify-between text-sm mb-1"><span>' + name + '</span><span>' + count + '</span></div>';
    });
    card4.innerHTML = '<h3 class="font-semibold mb-2">Tasks by Employee</h3>' + empHtml;
    summary.appendChild(card4);
    container.appendChild(summary);
    // If there are clients, show a grid to navigate to per-client analytics
    if (!state.clients || state.clients.length === 0) {
      const emptyDiv = document.createElement('div');
      emptyDiv.className = 'border-2 border-dashed rounded-2xl p-10 text-center text-zinc-600';
      emptyDiv.innerHTML = '<p class="mb-4">No clients yet. Add a client first to view client analytics.</p>';
      container.appendChild(emptyDiv);
    } else {
      const grid = document.createElement('div');
      grid.className = 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4';
      state.clients.forEach(c => {
        const card = document.createElement('div');
        card.className = 'bg-white rounded-2xl border p-4 shadow-sm cursor-pointer hover:bg-zinc-50';
        card.onclick = () => {
          state.analyticsClientId = c.id;
          render();
        };
        // Count tasks and events for this client
        const clientTasksCount = state.tasks.filter(t => t.clientId === c.id).length;
        const clientEventsCount = state.events.filter(ev => ev.clientId === c.id).length;
        card.innerHTML = `<div class="flex items-center gap-2 mb-2"><span class="inline-block w-3 h-3 rounded-full" style="background:${c.color}"></span><h3 class="font-medium">${c.name}</h3></div><p class="text-xs text-zinc-500">Tasks: ${clientTasksCount} • Events: ${clientEventsCount}</p>`;
        grid.appendChild(card);
      });
      container.appendChild(grid);
    }
  } else {
    // Show analytics details for selected client
    const client = state.clients.find(c => c.id === state.analyticsClientId);
    if (!client) {
      // If client missing, reset and return base page
      state.analyticsClientId = null;
      return renderAnalyticsPage();
    }
    // Back link
    const backBtn = document.createElement('button');
    backBtn.className = 'text-sm underline mb-4';
    backBtn.textContent = '← Back to clients';
    backBtn.onclick = () => {
      state.analyticsClientId = null;
      render();
    };
    container.appendChild(backBtn);
    // Title
    const title = document.createElement('h2');
    title.className = 'text-2xl font-semibold mb-4';
    title.textContent = client.name + ' Analytics';
    container.appendChild(title);
    // Handles form
    const handles = state.analyticsHandles[client.id] || { instagram:'', tiktok:'', youtube:'' };
    const form = document.createElement('div');
    form.className = 'space-y-4';
    form.innerHTML = `
      <div><label class="block text-sm mb-1">Instagram Username</label><input id="an-instagram" class="w-full px-3 py-2 rounded-xl border border-zinc-300" placeholder="e.g. client.ig" value="${handles.instagram || ''}"></div>
      <div><label class="block text-sm mb-1">TikTok Username</label><input id="an-tiktok" class="w-full px-3 py-2 rounded-xl border border-zinc-300" placeholder="e.g. client.tt" value="${handles.tiktok || ''}"></div>
      <div><label class="block text-sm mb-1">YouTube Channel ID</label><input id="an-youtube" class="w-full px-3 py-2 rounded-xl border border-zinc-300" placeholder="e.g. UCxxxxx" value="${handles.youtube || ''}"></div>
      <button type="button" id="analytics-save-btn" class="px-4 py-2 rounded-xl bg-black text-white">Save Handles</button>
    `;
    container.appendChild(form);
    // Analytics sections
    const sections = document.createElement('div');
    sections.className = 'grid grid-cols-1 md:grid-cols-3 gap-4 mt-6';
    [['Instagram','ig'],['TikTok','tt'],['YouTube','yt']].forEach(([label,key]) => {
      const sec = document.createElement('div');
      sec.className = 'bg-white rounded-2xl p-4 shadow-sm';
      sec.innerHTML = `<h3 class="font-semibold mb-2">${label} Analytics</h3><p class="text-sm text-zinc-500 mb-4">Connect ${label} API to fetch analytics.</p><button class="px-3 py-2 rounded-xl bg-zinc-100 border border-zinc-300 hover:bg-zinc-200" onclick="alert('TODO: implement ${label} analytics integration.')">Connect</button>`;
      sections.appendChild(sec);
    });
    container.appendChild(sections);
    // Attach save event after DOM insertion
    setTimeout(() => {
      const saveBtn = document.getElementById('analytics-save-btn');
      if (saveBtn) {
        saveBtn.addEventListener('click', () => {
          const newHandles = {
            instagram: document.getElementById('an-instagram').value.trim(),
            tiktok: document.getElementById('an-tiktok').value.trim(),
            youtube: document.getElementById('an-youtube').value.trim()
          };
          state.analyticsHandles[client.id] = newHandles;
          saveState();
          alert('Saved analytics handles!');
        });
      }
    }, 0);
  }
  return container;
}
function exitContentClient() { state.contentClientId = null; render(); }
function resetClientContent(clientId) {
  if (!confirm('Archive current content and start fresh?')) return;
  const content = state.contentData[clientId];
  if (content) {
    if (!state.contentArchive[clientId]) state.contentArchive[clientId] = [];
    state.contentArchive[clientId].push(Object.assign({}, content, { archivedAt: new Date().toISOString() }));
    delete state.contentData[clientId];
    saveState();
    render();
  }
}
async function saveContent(clientId, pkg) {
  const data = state.contentData[clientId] || {
    scripts: Array(pkg.videos).fill({ header:'', script:'' }),
    videos: Array(pkg.videos).fill(null),
    carousels: Array(pkg.carousels).fill([]),
    photos: Array(pkg.photos).fill(null),
    captions: Array(pkg.videos).fill(''),
    carouselCaptions: Array(pkg.carousels).fill(''),
    photoCaptions: Array(pkg.photos).fill(''),
    emails: Array(pkg.emails).fill(null),
    phones: Array(pkg.phones).fill(''),
    directMail: Array(pkg.directMail).fill(null),
    influencer: false,
    campaigns: 2
  };
  data.influencer = document.getElementById('influencerToggle').checked;
  data.campaigns = parseInt(document.getElementById('campaignsInput').value || 2);
  for (let i=0; i<pkg.videos; i++) {
    const header = document.getElementById('scriptHeader-' + i).value;
    const body = document.getElementById('scriptBody-' + i).value;
    const caption = document.getElementById('caption-' + i).value;
    data.scripts[i] = { header, script: body };
    data.captions[i] = caption;
    const fileInput = document.getElementById('videoUpload-' + i);
    const file = fileInput.files[0];
    if (file) {
      await new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = () => { data.videos[i] = reader.result; resolve(); };
        reader.readAsDataURL(file);
      });
    }
  }
  for (let i=0; i<pkg.carousels; i++) {
    const files = document.getElementById('carouselUpload-' + i).files;
    if (files && files.length) {
      data.carousels[i] = [];
      for (const file of files) {
        await new Promise(resolve => {
          const reader = new FileReader();
          reader.onload = () => { data.carousels[i].push(reader.result); resolve(); };
          reader.readAsDataURL(file);
        });
      }
    }
    // Save carousel caption
    const captionEl = document.getElementById('carouselCaption-' + i);
    if (captionEl) {
      data.carouselCaptions[i] = captionEl.value;
    }
  }
  for (let i=0; i<pkg.photos; i++) {
    const file = document.getElementById('photoUpload-' + i).files[0];
    if (file) {
      await new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = () => { data.photos[i] = reader.result; resolve(); };
        reader.readAsDataURL(file);
      });
    }
    // Save photo caption
    const photoCapEl = document.getElementById('photoCaption-' + i);
    if (photoCapEl) {
      data.photoCaptions[i] = photoCapEl.value;
    }
  }

  // Save email campaign documents
  for (let i=0; i<pkg.emails; i++) {
    const emailInput = document.getElementById('emailUpload-' + i);
    const file = emailInput && emailInput.files && emailInput.files[0];
    if (file) {
      await new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = () => { data.emails[i] = reader.result; resolve(); };
        reader.readAsDataURL(file);
      });
    }
  }
  // Save phone campaign text
  for (let i=0; i<pkg.phones; i++) {
    const textarea = document.getElementById('phoneText-' + i);
    if (textarea) {
      data.phones[i] = textarea.value;
    }
  }
  // Save direct mail uploads
  for (let i=0; i<pkg.directMail; i++) {
    const dmInput = document.getElementById('directMailUpload-' + i);
    const file = dmInput && dmInput.files && dmInput.files[0];
    if (file) {
      await new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = () => { data.directMail[i] = reader.result; resolve(); };
        reader.readAsDataURL(file);
      });
    }
  }
  data.updatedAt = new Date().toISOString();
  state.contentData[clientId] = data;
  saveState();
  alert('Content saved.');
  render();
}

// Dynamically add or remove content slots for a client
function adjustContentSlots(clientId, type, delta) {
  const content = state.contentData[clientId];
  if (!content) return;
  // Add a new slot
  const addSlot = (t) => {
    switch (t) {
      case 'videos':
        content.scripts.push({ header:'', script:'' });
        content.videos.push(null);
        content.captions.push('');
        break;
      case 'carousels':
        content.carousels.push([]);
        if (!content.carouselCaptions) content.carouselCaptions = [];
        content.carouselCaptions.push('');
        break;
      case 'photos':
        content.photos.push(null);
        if (!content.photoCaptions) content.photoCaptions = [];
        content.photoCaptions.push('');
        break;
      case 'emails':
        content.emails.push(null);
        break;
      case 'phones':
        content.phones.push('');
        break;
      case 'directMail':
        content.directMail.push(null);
        break;
    }
  };
  // Remove the last slot when more than one exists
  const removeSlot = (t) => {
    switch (t) {
      case 'videos':
        if (content.scripts.length > 1) {
          content.scripts.pop();
          content.videos.pop();
          content.captions.pop();
        }
        break;
      case 'carousels':
        if (content.carousels.length > 1) {
          content.carousels.pop();
          if (content.carouselCaptions) content.carouselCaptions.pop();
        }
        break;
      case 'photos':
        if (content.photos.length > 1) {
          content.photos.pop();
          if (content.photoCaptions) content.photoCaptions.pop();
        }
        break;
      case 'emails':
        if (content.emails.length > 1) content.emails.pop();
        break;
      case 'phones':
        if (content.phones.length > 1) content.phones.pop();
        break;
      case 'directMail':
        if (content.directMail.length > 1) content.directMail.pop();
        break;
    }
  };
  if (delta > 0) {
    addSlot(type);
  } else if (delta < 0) {
    removeSlot(type);
  }
  // Persist and re-render
  state.contentData[clientId] = content;
  saveState();
  render();
}

// Event modals (reuse earlier definitions)
function openEventModal(clientId, date) {
  let draft = { type:'task', title:'', date, endDate:date, multi:false, allDay:true, time:'', phase:'Scripting' };
  openModal('New Entry', () => {
    const div = document.createElement('div');
    div.innerHTML = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">' +
      '<div><label class="block text-sm mb-1">Type</label><select id="evType" class="w-full px-3 py-2 rounded-xl border border-zinc-300"><option value="task">Task</option><option value="event">Event</option><option value="item">Item</option></select></div>' +
      '<div><label class="block text-sm mb-1">Date</label><input id="evDate" type="date" value="' + date + '" class="w-full px-3 py-2 rounded-xl border border-zinc-300" /></div>' +
      '<div><label class="block text-sm mb-1">End date</label><input id="evEndDate" type="date" value="' + date + '" class="w-full px-3 py-2 rounded-xl border border-zinc-300" /></div>' +
      '<div class="flex items-center gap-2 mt-6"><input id="evMulti" type="checkbox" class="mr-2"/><label for="evMulti" class="text-sm">Create on every day from start → end</label></div>' +
      '<div class="md:col-span-2"><label class="block text-sm mb-1">Title</label><input id="evTitle" class="w-full px-3 py-2 rounded-xl border border-zinc-300" placeholder="What is this?" /></div>' +
      '<div><label class="block text-sm mb-1">Phase</label><div class="inline-flex rounded-2xl bg-zinc-100 dark:bg-zinc-800 p-1" id="evPhaseSeg">' + ['None','Scripting','Filming'].map(p => '<button data-phase="' + p + '" class="px-3 py-1.5 rounded-xl text-sm ' + (p==='Scripting' ? 'bg-white dark:bg-zinc-900 shadow text-zinc-900 dark:text-zinc-100' : (p==='None' ? 'text-zinc-600 hover:text-zinc-900' : 'text-zinc-600 hover:text-zinc-900')) + '">' + p + '</button>').join('') + '</div><p class="text-xs mt-1 text-zinc-500">None = gray, Scripting = red, Filming = blue</p></div>' +
      '<div><label class="block text-sm mb-1">Time</label><div class="flex items-center gap-2"><input id="evTime" type="time" class="flex-1 px-3 py-2 rounded-xl border border-zinc-300 disabled:opacity-50" disabled /><label class="inline-flex items-center gap-2 text-sm"><input id="evAllDay" type="checkbox" checked /> All day</label></div></div>' +
      '</div><div class="flex items-center justify-end mt-6"><button class="px-4 py-2 rounded-xl bg-zinc-100 mr-2" onclick="closeModal()">Cancel</button><button id="evSaveBtn" class="px-4 py-2 rounded-xl bg-black text-white">Save</button></div>';
    const phaseSeg = div.querySelector('#evPhaseSeg');
    phaseSeg.querySelectorAll('button').forEach(btn => {
      btn.addEventListener('click', () => {
        draft.phase = btn.getAttribute('data-phase');
        phaseSeg.querySelectorAll('button').forEach(b => b.className = b.className.replace(/bg-[^\s]+|shadow|text-zinc-900|text-zinc-100/g, ''));
        btn.className = 'px-3 py-1.5 rounded-xl text-sm bg-white dark:bg-zinc-900 shadow text-zinc-900 dark:text-zinc-100';
      });
    });
    const allDayCheckbox = div.querySelector('#evAllDay');
    const timeInput = div.querySelector('#evTime');
    allDayCheckbox.addEventListener('change', () => {
      draft.allDay = allDayCheckbox.checked;
      timeInput.disabled = draft.allDay;
    });
    div.querySelector('#evSaveBtn').addEventListener('click', () => {
      draft.type = div.querySelector('#evType').value;
      draft.date = div.querySelector('#evDate').value;
      draft.endDate = div.querySelector('#evEndDate').value;
      draft.multi = div.querySelector('#evMulti').checked;
      draft.title = div.querySelector('#evTitle').value.trim();
      draft.time = timeInput.value;
      if (!draft.title) return alert('Title required');
        if (draft.multi && draft.endDate && draft.endDate >= draft.date) {
        let s = new Date(draft.date + 'T00:00:00');
        let e = new Date(draft.endDate + 'T00:00:00');
        const out = [];
        for (let d = new Date(s); d <= e; d.setDate(d.getDate() + 1)) {
          out.push({ id: uid(), clientId, type: draft.type, title: draft.title, date: d.toISOString().slice(0,10), allDay: draft.allDay, time: draft.time, phase: draft.phase, status:'todo' });
        }
        state.events = state.events.concat(out);
      } else {
        state.events.push({ id: uid(), clientId, type: draft.type, title: draft.title, date: draft.date, allDay: draft.allDay, time: draft.time, phase: draft.phase, status:'todo' });
      }
      saveState();
      closeModal();
      render();
    });
    return div;
  });
}
function openEditEventModal(ev) {
  let draft = Object.assign({}, ev);
  openModal('Edit Entry', () => {
    const div = document.createElement('div');
    div.innerHTML = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">' +
      '<div><label class="block text-sm mb-1">Type</label><select id="evType" class="w-full px-3 py-2 rounded-xl border border-zinc-300"><option value="task">Task</option><option value="event">Event</option><option value="item">Item</option></select></div>' +
      '<div><label class="block text-sm mb-1">Date</label><input id="evDate" type="date" value="' + draft.date + '" class="w-full px-3 py-2 rounded-xl border border-zinc-300" /></div>' +
      '<div class="md:col-span-2"><label class="block text-sm mb-1">Title</label><input id="evTitle" class="w-full px-3 py-2 rounded-xl border border-zinc-300" placeholder="What is this?" value="' + draft.title + '" /></div>' +
      '<div><label class="block text-sm mb-1">Phase</label><div class="inline-flex rounded-2xl bg-zinc-100 dark:bg-zinc-800 p-1" id="evPhaseSeg">' + ['None','Scripting','Filming'].map(p => '<button data-phase="' + p + '" class="px-3 py-1.5 rounded-xl text-sm ' + (draft.phase===p ? 'bg-white dark:bg-zinc-900 shadow text-zinc-900 dark:text-zinc-100' : 'text-zinc-600 hover:text-zinc-900') + '">' + p + '</button>').join('') + '</div><p class="text-xs mt-1 text-zinc-500">None = gray, Scripting = red, Filming = blue</p></div>' +
      '<div><label class="block text-sm mb-1">Time</label><div class="flex items-center gap-2"><input id="evTime" type="time" value="' + (draft.time||'') + '" class="flex-1 px-3 py-2 rounded-xl border border-zinc-300 ' + (draft.allDay?'disabled:opacity-50':'') + '" ' + (draft.allDay?'disabled':'') + '/><label class="inline-flex items-center gap-2 text-sm"><input id="evAllDay" type="checkbox" ' + (draft.allDay?'checked':'') + '/> All day</label></div></div>' +
      '</div><div class="flex items-center justify-between mt-6"><button id="evDeleteMenu" class="p-2 rounded-lg hover:bg-zinc-100">⋮</button><div><button onclick="closeModal()" class="px-4 py-2 rounded-xl bg-zinc-100 mr-2">Cancel</button><button id="evSaveBtn" class="px-4 py-2 rounded-xl bg-black text-white">Save</button></div></div>';
    const phaseSeg = div.querySelector('#evPhaseSeg');
    phaseSeg.querySelectorAll('button').forEach(btn => {
      btn.addEventListener('click', () => {
        draft.phase = btn.getAttribute('data-phase');
        phaseSeg.querySelectorAll('button').forEach(b => b.className = b.className.replace(/bg-[^\s]+|shadow|text-zinc-900|text-zinc-100/g, ''));
        btn.className = 'px-3 py-1.5 rounded-xl text-sm bg-white dark:bg-zinc-900 shadow text-zinc-900 dark:text-zinc-100';
      });
    });
    const allDayCheckbox = div.querySelector('#evAllDay');
    const timeInput = div.querySelector('#evTime');
    allDayCheckbox.addEventListener('change', () => {
      draft.allDay = allDayCheckbox.checked;
      timeInput.disabled = draft.allDay;
    });
    div.querySelector('#evDeleteMenu').addEventListener('click', () => {
      // open a confirmation modal using the global confirm flow
      openDeleteEventConfirm(ev.id);
    });
    div.querySelector('#evSaveBtn').addEventListener('click', () => {
      draft.type = div.querySelector('#evType').value;
      draft.date = div.querySelector('#evDate').value;
      draft.title = div.querySelector('#evTitle').value.trim();
      draft.time = timeInput.value;
      if (!draft.title) return alert('Title required');
      state.events = state.events.map(e => e.id === ev.id ? Object.assign({}, e, draft) : e);
      saveState();
      closeModal();
      render();
    });
    return div;
  });
}

// ==== Task Utilities ====
// Mark a task as complete (archived). Removes it from active lists and re-renders.
function completeTask(taskId) {
  const idx = (state.tasks || []).findIndex(t => t.id === taskId);
  if (idx >= 0) {
    const task = state.tasks[idx];
    // mark completed
    state.tasks[idx] = Object.assign({}, task, { status: 'done' });
    saveState();
    render();
  }
}

// Mark an event as complete (archived). Sets its status to 'done' so it is hidden
// from active calendars and lists. After updating, the state is saved and
// the UI is re-rendered. If the event cannot be found, nothing happens.
function completeEvent(eventId) {
  const idx = state.events.findIndex(ev => ev.id === eventId);
  if (idx === -1) return;
  const ev = state.events[idx];
  // Mark the event as done. Preserve all other fields.
  state.events[idx] = Object.assign({}, ev, { status: 'done' });
  saveState();
  render();
}

// Track the currently open task popover globally so we can close it when
// opening a new one or when clicking outside. When non-null, this DOM
// element is appended to the body.
let activeTaskPopover = null;

// Display a small contextual popover near a task element. The popover shows
// actions such as Edit and Mark Done. The calendar range of the task's due
// date is highlighted while the popover is visible. When the user clicks
// outside the popover, it automatically closes. `taskId` is the id of
// the task, and `anchorEl` is the element that was clicked.
function openTaskPopover(taskId, anchorEl) {
  const task = (state.tasks || []).find(t => t.id === taskId);
  if (!task || !anchorEl) return;
  // highlight the due date on the calendar
  if (task.dueDate) {
    highlightCalendarRange(task.dueDate, task.dueDate);
  }
  // remove any existing popover
  if (activeTaskPopover) {
    activeTaskPopover.remove();
    activeTaskPopover = null;
  }
  const rect = anchorEl.getBoundingClientRect();
  const pop = document.createElement('div');
  pop.className = 'z-50 absolute bg-white border border-zinc-200 rounded-xl shadow-lg text-sm';
  // position the popover above the anchor; if not enough space, place below
  const top = rect.top + window.scrollY - 40;
  const left = rect.left + window.scrollX;
  pop.style.top = (top < 0 ? rect.bottom + window.scrollY + 8 : top) + 'px';
  pop.style.left = left + 'px';
  pop.innerHTML =
    '<button onclick="openAssignModal(\'' + taskId + '\')" class="block w-full text-left px-3 py-1 hover:bg-zinc-100">Assign</button>' +
    '<button onclick="openEditTaskModal(\'' + taskId + '\')" class="block w-full text-left px-3 py-1 hover:bg-zinc-100">Edit</button>' +
    '<button onclick="openCompletionPrompt(\'task\', \'' + taskId + '\')" class="block w-full text-left px-3 py-1 hover:bg-zinc-100">Mark Done</button>';
  document.body.appendChild(pop);
  activeTaskPopover = pop;
  // outside click handler
  setTimeout(() => {
    function handleClick(e) {
      if (activeTaskPopover && !activeTaskPopover.contains(e.target)) {
        activeTaskPopover.remove();
        activeTaskPopover = null;
        document.removeEventListener('click', handleClick);
      }
    }
    document.addEventListener('click', handleClick);
  }, 0);
}
// Wrapper to edit an existing event via triple‑dot button. Accepts an event id
// and opens the edit modal for that event. It will not render the modal if
// the event cannot be found.
function openEventOptions(eventId) {
  const ev = state.events.find(e => e.id === eventId);
  if (!ev) return;
  openEditEventModal(ev);
}

// Open a modal to edit an existing task. Prefills current values and allows deletion.
function openEditTaskModal(taskId) {
  const task = (state.tasks || []).find(t => t.id === taskId);
  if (!task) return;
  let draft = Object.assign({}, task);
  openModal('Edit Task', () => {
    const div = document.createElement('div');
    div.innerHTML = '<div class="space-y-4">' +
      '<div><label class="block text-sm mb-1">Task Title</label><input id="editTaskTitle" value="' + (draft.title || '') + '" class="w-full px-3 py-2 rounded-xl border border-zinc-300" /></div>' +
      '<div class="grid grid-cols-1 md:grid-cols-3 gap-4">' +
        '<div><label class="block text-sm mb-1">Start Date</label><input id="editTaskStartDate" type="date" value="' + (draft.startDate || draft.dueDate || todayISO()) + '" class="w-full px-3 py-2 rounded-xl border border-zinc-300" /></div>' +
        '<div><label class="block text-sm mb-1">Due Date</label><input id="editTaskDueDate" type="date" value="' + (draft.dueDate || todayISO()) + '" class="w-full px-3 py-2 rounded-xl border border-zinc-300" /></div>' +
        '<div><label class="block text-sm mb-1">Time (optional)</label><input id="editTaskTime" type="time" value="' + (draft.time || '') + '" class="w-full px-3 py-2 rounded-xl border border-zinc-300" /></div>' +
      '</div>' +
      '<div><label class="block text-sm mb-1">Estimate Hours (optional)</label><input id="editTaskEst" type="number" min="0.25" step="0.25" value="' + (draft.estimateHours || '') + '" class="w-full px-3 py-2 rounded-xl border border-zinc-300" /></div>' +
      '<div><label class="block text-sm mb-1">Phase</label><select id="editTaskPhase" class="w-full px-3 py-2 rounded-xl border border-zinc-300">' +
        '<option value="None"' + (draft.phase === 'None' ? ' selected' : '') + '>None</option>' +
        '<option value="Scripting"' + (draft.phase === 'Scripting' ? ' selected' : '') + '>Scripting</option>' +
        '<option value="Filming"' + (draft.phase === 'Filming' ? ' selected' : '') + '>Filming</option>' +
      '</select></div>' +
      '</div>' +
      '<div class="flex items-center justify-between gap-2 mt-6">' +
        '<button id="editTaskDeleteBtn" class="px-3 py-2 rounded-xl bg-red-100 text-red-700">Delete</button>' +
        '<div><button onclick="closeModal()" class="px-4 py-2 rounded-xl bg-zinc-100 mr-2">Cancel</button><button id="editTaskSaveBtn" class="px-4 py-2 rounded-xl bg-black text-white">Save</button></div>' +
      '</div>';
    setTimeout(() => {
      const titleInput = div.querySelector('#editTaskTitle');
      const startInput = div.querySelector('#editTaskStartDate');
      const dueInput = div.querySelector('#editTaskDueDate');
      const timeInput = div.querySelector('#editTaskTime');
      const estInput = div.querySelector('#editTaskEst');
      const phaseInput = div.querySelector('#editTaskPhase');
      div.querySelector('#editTaskSaveBtn').addEventListener('click', () => {
        draft.title = titleInput.value.trim();
        // Normalize start and due dates: default to whichever is provided and swap if start > due
        let sDate = startInput.value || null;
        let dDate = dueInput.value || null;
        if (sDate && dDate && sDate > dDate) {
          const tmp = sDate;
          sDate = dDate;
          dDate = tmp;
        }
        draft.startDate = sDate;
        draft.dueDate = dDate;
        draft.time = timeInput.value;
        draft.estimateHours = estInput.value ? Number(estInput.value) : null;
        draft.phase = phaseInput.value || 'None';
        if (!draft.title) { alert('Title required'); return; }
        // Update the task
        state.tasks = (state.tasks || []).map(t => t.id === taskId ? Object.assign({}, t, draft) : t);
        saveState();
        closeModal();
        render();
      });
      div.querySelector('#editTaskDeleteBtn').addEventListener('click', () => {
        if (confirm('Delete this task?')) {
          state.tasks = (state.tasks || []).filter(t => t.id !== taskId);
          saveState();
          closeModal();
          render();
        }
      });
    }, 0);
    return div;
  });
}

// Simple wrapper to open the task edit modal, used by triple‑dot buttons
function openTaskOptions(taskId, ev) {
  // Show a small popup menu near the click target with Assign and Edit actions. If
  // no event is passed, attempt to use the global window.event to position the menu.
  // Remove any existing menu
  const existing = document.getElementById('task-options-menu');
  if (existing) existing.remove();
  // Create menu container
  const menu = document.createElement('div');
  menu.id = 'task-options-menu';
  menu.className = 'absolute bg-white border border-zinc-200 rounded-xl shadow-lg';
  menu.style.zIndex = '1000';
  // Position the menu near the click location; fallback to center of the viewport if no event
  // Determine coordinates from the event, falling back to window.event or center
  const eventObj = ev || (typeof window !== 'undefined' && window.event);
  const x = (eventObj && eventObj.clientX) || (window.innerWidth / 2);
  const y = (eventObj && eventObj.clientY) || (window.innerHeight / 2);
  menu.style.left = x + 'px';
  menu.style.top = y + 'px';
  // Build menu items
  const assignBtn = document.createElement('button');
  assignBtn.className = 'block w-full text-left px-3 py-2 text-sm hover:bg-zinc-100';
  assignBtn.textContent = 'Assign';
  assignBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    menu.remove();
    openAssignModal(taskId);
  });
  const editBtn = document.createElement('button');
  editBtn.className = 'block w-full text-left px-3 py-2 text-sm hover:bg-zinc-100';
  editBtn.textContent = 'Edit';
  editBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    menu.remove();
    openEditTaskModal(taskId);
  });
  // Style small spacing
  menu.style.minWidth = '120px';
  menu.appendChild(assignBtn);
  menu.appendChild(editBtn);
  // Append to body
  document.body.appendChild(menu);
  // Close on outside click
  setTimeout(() => {
    function handleClickOutside(event) {
      if (!menu.contains(event.target)) {
        menu.remove();
        document.removeEventListener('click', handleClickOutside);
      }
    }
    document.addEventListener('click', handleClickOutside);
  }, 0);
}

// Initial render
render();

</script>
<!--
  Override openEventOptions to present Assign/Edit menu for events,
  and provide a modal to assign events to employees. This ensures
  events on the calendar can also be delegated to team members.
-->
<script>
// Override openEventOptions to show Assign/Edit options for events
window.openEventOptions = function(eventId, ev) {
  const e = ev || window.event;
  // locate the event object
  const evObj = (state.events || []).find(ev => ev.id === eventId);
  if (!evObj) {
    // fallback to original edit if not found
    window.openEditEventModal && window.openEditEventModal({ id: eventId });
    return;
  }
  // Remove any existing menu
  const old = document.getElementById('event-options-menu');
  if (old) old.remove();
  // Build menu container
  const menu = document.createElement('div');
  menu.id = 'event-options-menu';
  menu.className = 'fixed z-50 bg-white border border-zinc-200 rounded-xl shadow-lg text-sm';
  const x = (e && e.clientX) || (window.innerWidth/2);
  const y = (e && e.clientY) || (window.innerHeight/2);
  menu.style.left = (x + 4) + 'px';
  menu.style.top  = (y + 8) + 'px';
  menu.innerHTML =
    '<button data-act="assign" class="block w-full text-left px-3 py-1.5 hover:bg-zinc-100">Assign</button>' +
    '<button data-act="edit"   class="block w-full text-left px-3 py-1.5 hover:bg-zinc-100">Edit</button>';
  document.body.appendChild(menu);
  function close() {
    if (menu.parentNode) menu.parentNode.removeChild(menu);
    document.removeEventListener('click', outside);
  }
  function outside(evt) {
    if (!menu.contains(evt.target)) close();
  }
  setTimeout(() => document.addEventListener('click', outside), 0);
  menu.addEventListener('click', (evt) => {
    const act = evt.target && evt.target.dataset && evt.target.dataset.act;
    if (act === 'assign') {
      close();
      window.openAssignEventModal(eventId);
    } else if (act === 'edit') {
      close();
      window.openEditEventModal(evObj);
    }
  });
};
// Provide a modal to assign events to employees by duplicating the event
window.openAssignEventModal = function(eventId) {
  const ev = (state.events || []).find(e => e.id === eventId);
  if (!ev) return;
  // overlay
  const overlay = document.createElement('div');
  overlay.style.position='fixed';
  overlay.style.inset='0';
  overlay.style.background='rgba(0,0,0,.35)';
  overlay.style.zIndex='9999';
  // card
  const card = document.createElement('div');
  card.className = 'bg-white rounded-2xl shadow-xl p-4 w-[380px] max-w-[90vw] mx-auto mt-24';
  card.innerHTML = '<h3 class="font-semibold mb-3">Assign event</h3>';
  const list = document.createElement('div');
  list.className = 'space-y-2';
  (state.employees || []).forEach(emp => {
    const btn = document.createElement('button');
    btn.className = 'w-full text-left px-3 py-2 rounded-xl border border-zinc-300 hover:bg-zinc-50';
    btn.textContent = emp.name;
    btn.onclick = () => {
      // Assign the existing event to the selected employee instead of duplicating.
      // Update the assignee property on the event. The manager will still see the event
      // once with a suffix indicating the assignee.
      ev.assignee = emp.id;
      // Remove any lingering duplicate events with matching title, date/time, client and phase
      state.events = (state.events || []).filter(e => {
        if (e.id === ev.id) return true;
        const sameTitle = e.title === ev.title;
        const sameDate  = e.date === ev.date;
        const sameTime  = (e.time || '') === (ev.time || '');
        const sameClient= e.clientId === ev.clientId;
        const samePhase = (e.phase || '') === (ev.phase || '');
        const sameAllDay= (e.allDay || false) === (ev.allDay || false);
        return !(sameTitle && sameDate && sameTime && sameClient && samePhase && sameAllDay);
      });
      saveState();
      // If using Supabase, update the existing event row. Adjust table/filters as needed.
      if (window.supabase && window.supabase.from) {
        const payload = { assignee: emp.id };
        window.supabase.from('employee_tasks')
          .update(payload)
          .eq('clientId', ev.clientId)
          .eq('title', ev.title)
          .eq('date', ev.date)
          .then(() => {});
      }
      overlay.remove();
      render();
    };
    list.appendChild(btn);
  });
  const cancelBtn = document.createElement('button');
  cancelBtn.className = 'mt-3 px-3 py-2 rounded-xl bg-zinc-100';
  cancelBtn.textContent = 'Cancel';
  cancelBtn.onclick = () => overlay.remove();
  card.appendChild(list);
  card.appendChild(cancelBtn);
  overlay.appendChild(card);
  document.body.appendChild(overlay);
};
</script>
<!--
  Override script to ensure the 3‑dot context menu shows Assign/Edit options for tasks
  and provide a simple assignment modal. This script executes after all existing
  scripts have run and overrides the original openTaskOptions and openAssignModal
  functions. It uses the global state and helper functions like uid(), saveState
  and render() defined earlier in the application. If no click event is passed
  to openTaskOptions, it gracefully falls back to window.event.
-->
<script>
// Override openTaskOptions to display a mini menu with Assign and Edit
window.openTaskOptions = function(taskId, ev) {
  const e = ev || window.event;
  // Remove any existing menu
  const old = document.getElementById('task-options-menu');
  if (old) old.remove();
  // Create menu container
  const menu = document.createElement('div');
  menu.id = 'task-options-menu';
  menu.className = 'fixed z-50 bg-white border border-zinc-200 rounded-xl shadow-lg text-sm';
  // Position near cursor; default to center if event missing
  const x = (e && e.clientX) || (window.innerWidth / 2);
  const y = (e && e.clientY) || (window.innerHeight / 2);
  menu.style.left = (x + 4) + 'px';
  menu.style.top  = (y + 8) + 'px';
  menu.innerHTML =
    '<button data-act="assign" class="block w-full text-left px-3 py-1.5 hover:bg-zinc-100">Assign</button>' +
    '<button data-act="edit"   class="block w-full text-left px-3 py-1.5 hover:bg-zinc-100">Edit</button>';
  document.body.appendChild(menu);
  // Helper to close menu on outside click
  function closeMenu() {
    if (menu.parentNode) menu.parentNode.removeChild(menu);
    document.removeEventListener('click', outside);
  }
  function outside(evt) {
    if (!menu.contains(evt.target)) closeMenu();
  }
  // Delay adding outside click listener to avoid immediate removal
  setTimeout(() => document.addEventListener('click', outside), 0);
  menu.addEventListener('click', (evt) => {
    const act = evt.target && evt.target.dataset && evt.target.dataset.act;
    if (act === 'assign') {
      closeMenu();
      window.openAssignModal(taskId);
    } else if (act === 'edit') {
      closeMenu();
      window.openEditTaskModal(taskId);
    }
  });
};

// Override openAssignModal to show a list of employees and duplicate the task
window.openAssignModal = function(taskId) {
  const task = (state.tasks || []).find(t => t.id === taskId);
  if (!task) return;
  // Overlay
  const overlay = document.createElement('div');
  overlay.style.position = 'fixed';
  overlay.style.inset = '0';
  overlay.style.background = 'rgba(0,0,0,.35)';
  overlay.style.zIndex = '9999';
  // Card container
  const card = document.createElement('div');
  card.className = 'bg-white rounded-2xl shadow-xl p-4 w-[380px] max-w-[90vw] mx-auto mt-24';
  card.innerHTML = '<h3 class="font-semibold mb-3">Assign task</h3>';
  // Employee list
  const list = document.createElement('div');
  list.className = 'space-y-2';
  (state.employees || []).forEach(emp => {
    const btn = document.createElement('button');
    btn.className = 'w-full text-left px-3 py-2 rounded-xl border border-zinc-300 hover:bg-zinc-50';
    btn.textContent = emp.name;
    btn.onclick = () => {
      // Assign the existing task to the selected employee instead of duplicating.
      // This updates the assignee property on the original task. The manager
      // will still see the task once with a suffix indicating the assignee.
      task.assignee = emp.id;
      // Remove any lingering duplicate tasks with matching title, due date, client, phase and start date
      state.tasks = (state.tasks || []).filter(t => {
        if (t.id === task.id) return true;
        const sameTitle = t.title === task.title;
        const sameDue   = t.dueDate === task.dueDate;
        const sameClient= t.clientId === task.clientId;
        const samePhase = (t.phase || '') === (task.phase || '');
        const sameStart = (t.startDate || '') === (task.startDate || '');
        return !(sameTitle && sameDue && sameClient && samePhase && sameStart);
      });
      saveState();
      // If Supabase integration exists, update the task record instead of inserting a new one.
      if (window.supabase && window.supabase.from) {
        const due = task.dueDate || null;
        window.supabase.from('employee_tasks')
          .update({ assignee: emp.id })
          .eq('title', task.title)
          .eq('due_date', due)
          .then(() => {});
      }
      overlay.remove();
      render();
    };
    list.appendChild(btn);
  });
  // Cancel button
  const cancelBtn = document.createElement('button');
  cancelBtn.className = 'mt-3 px-3 py-2 rounded-xl bg-zinc-100';
  cancelBtn.textContent = 'Cancel';
  cancelBtn.onclick = () => overlay.remove();
  card.appendChild(list);
  card.appendChild(cancelBtn);
  overlay.appendChild(card);
  document.body.appendChild(overlay);
};
</script>
  <!-- Version label displayed in the bottom-right corner to indicate build version -->
  <div style="position: fixed; bottom: 4px; right: 8px; font-size: 10px; color: #888;">
    vAug15-J
  </div>
  <!-- Supabase Auth script to power the login overlay -->
  <script type="module">
    // Initialize Supabase using explicit credentials. Because this file
    // runs as a standalone HTML page without a build step, import.meta.env
    // is unavailable in production. To ensure Supabase works on the
    // deployed site, we hardcode the URL and anon key here. If you change
    // your Supabase project or rotate keys, update these values.
    const sbUrl = 'https://pgohlxaeakbxiqekkwrl.supabase.co';
    const sbKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBnb2hseGFlYWtieGlxZWtrd3JsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5NzU3MjEsImV4cCI6MjA3MDU1MTcyMX0.5RF__rQEwwSVFSNfbOce5YyKwc1gzH6FG8OpXbNugxI';
    let supabaseInstance;
    try {
      supabaseInstance = createClient(sbUrl, sbKey);
    } catch (err) {
      console.warn('Supabase initialization failed:', err);
      // Provide a minimal stub so calls to supabase.functions.invoke() do not crash
      supabaseInstance = {
        functions: {
          invoke: async () => ({ data: null, error: { message: 'Supabase disabled locally' } })
        }
      };
    }
    // Expose the Supabase client globally so it can be used by non‑module
    // scripts (e.g. generateVideoIdeas). Without this assignment, the
    // client would be scoped only to this module and unavailable in
    // other functions defined outside of the module context.
    window.supabase = supabaseInstance;

    // Persist the Supabase URL and anonymous key on the window so other
    // scripts can construct fallback URLs for function invocation when
    // supabase.functions.invoke fails (for example, due to CORS or network
    // restrictions). These come from your Vite environment variables or
    // fallback placeholders. Do not expose these in production builds
    // if you do not intend to call functions directly via fetch.
    // Persist the Supabase URL and anon key for function fallbacks. Since we
    // are running without a build step, import.meta.env is unavailable.
    // Hardcode the same values used above so that functions can construct
    // fallback URLs.
    window.SUPABASE_URL = 'https://pgohlxaeakbxiqekkwrl.supabase.co';
    window.SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBnb2hseGFlYWtieGlxZWtrd3JsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5NzU3MjEsImV4cCI6MjA3MDU1MTcyMX0.5RF__rQEwwSVFSNfbOce5YyKwc1gzH6FG8OpXbNugxI';
    // Show or hide the login overlay based on login flag
    window.addEventListener('DOMContentLoaded', () => {
      const overlay = document.getElementById('login-overlay');
      if (!overlay) return;
      // If a login flag is present or Supabase auth is unavailable (offline/local mode), skip the overlay
      const loggedIn = localStorage.getItem('mm_loggedIn') === 'true';
      const authAvailable = window.supabase && window.supabase.auth;
      if (loggedIn || !authAvailable) {
        // Mark logged in automatically if auth is unavailable to avoid blocking the UI
        localStorage.setItem('mm_loggedIn', 'true');
        overlay.style.display = 'none';
      } else {
        overlay.style.display = 'flex';
      }
    });
    // Handle login/signup form submission
    document.getElementById('supabase-login-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      // If auth is not available, just mark logged in and render immediately
      if (!supabase || !supabase.auth) {
        localStorage.setItem('mm_loggedIn', 'true');
        document.getElementById('login-overlay').style.display = 'none';
        render();
        return;
      }
      // Try signing in first
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) {
        // If login fails, attempt sign up
        const { data: signUpData, error: signUpError } = await supabase.auth.signUp({ email, password });
        if (signUpError) {
          alert(signUpError.message);
          return;
        }
        // If sign up succeeds, mark as logged in and hide overlay
        localStorage.setItem('mm_loggedIn', 'true');
        document.getElementById('login-overlay').style.display = 'none';
        render();
        return;
      }
      // Login succeeded; hide overlay and render app
      localStorage.setItem('mm_loggedIn', 'true');
      document.getElementById('login-overlay').style.display = 'none';
      render();
    });
  </script>
</body>
</html>
